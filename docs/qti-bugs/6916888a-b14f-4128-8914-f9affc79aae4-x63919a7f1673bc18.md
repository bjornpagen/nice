# Flowers in vases: write an equation and find the total

- **analysisId**: 6916888a-b14f-4128-8914-f9affc79aae4
- **questionId**: x63919a7f1673bc18
- **severity**: minor

### Issue
The text "Flower" appears on top of the image of the flower. This should only be alt text if the flower is unable to render. The acceptable variations of the correct equation answer "f/22=4" (i.e, "f/22 = 4", "4=f/22", "4 = f/22") are being marked as incorrect.

### Perseus (original)
```json
{
  "hints": [
    {
      "images": {},
      "content": "Amia picked a total of  $\\blueD{f}$ flowers at the farm.\n\nShe put the flowers in  $\\greenD{4}$ vases with $\\maroonD{22}$ flowers in each vase.",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "We can find out how many total flowers Amia picked by finding the quotient: \n\n$\\greenD{4}=\\dfrac{\\blueD{f}}{\\maroonD{22}}$\n\n\nOther ways to represent the situation with an equation include: $\\dfrac{\\blueD{f}}{\\greenD{4} }=\\maroonD{22}$ or $\\maroonD{22} \\cdot {\\greenD{4}}=\\blueD{f}$.",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "Now we can solve for $\\blueD{f}$. \n\nMultiply both sides by $\\maroonD{22}$ to get $\\blueD f$ by itself.\n\n\n\n$\\begin{align} \\greenD{4\\cdot \\maroonD {22} }&=\\dfrac{\\blueD{f}}{\\maroonD{22}} \\cdot \\maroonD{22}\n\\\\ \\\\\n\\blueD f &=\\blueD{88} \\end{align}$",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "The following equation matches this situation:\n\n$4=\\dfrac{f}{22}$\n\nAmia picked $88$ flowers at the farm.",
      "replace": false,
      "widgets": {}
    }
  ],
  "question": {
    "images": {},
    "content": "\n\n[[â˜ƒ image 1]]\n\nAmia went to a flower farm and picked $f$ flowers. When she got home, she put the flowers in $4$ vases, with $22$ flowers in each vase. \n\n**Write an equation to describe this situation.**\n\n[[â˜ƒ expression 3]]\n\n**How many flowers did Amia pick at the farm?** \n\n\n[[â˜ƒ numeric-input 1]]",
    "widgets": {
      "image 1": {
        "type": "image",
        "graded": true,
        "static": false,
        "options": {
          "alt": "Image of a flower.",
          "box": [
            128,
            128
          ],
          "range": [
            [
              0,
              10
            ],
            [
              0,
              10
            ]
          ],
          "title": "",
          "labels": [],
          "static": false,
          "caption": "",
          "backgroundImage": {
            "url": "web+graphie://cdn.kastatic.org/ka-perseus-graphie/8897bf04042514a6efdff51a1f36d8808ca54b13",
            "width": 128,
            "height": 128
          }
        },
        "version": {
          "major": 0,
          "minor": 0
        },
        "alignment": "block"
      },
      "expression 3": {
        "type": "expression",
        "graded": true,
        "static": false,
        "options": {
          "times": false,
          "functions": [
            "g",
            "h"
          ],
          "buttonSets": [
            "basic",
            "prealgebra"
          ],
          "answerForms": [
            {
              "key": 0,
              "form": false,
              "value": "\\frac{f}{22}=4",
              "simplify": false,
              "considered": "correct"
            }
          ]
        },
        "version": {
          "major": 1,
          "minor": 0
        },
        "alignment": "default"
      },
      "numeric-input 1": {
        "type": "numeric-input",
        "graded": true,
        "static": false,
        "options": {
          "size": "normal",
          "static": false,
          "answers": [
            {
              "value": 88,
              "status": "correct",
              "strict": false,
              "message": "",
              "maxError": null,
              "simplify": "required"
            }
          ],
          "labelText": "",
          "coefficient": false,
          "multipleNumberInput": false
        },
        "version": {
          "major": 0,
          "minor": 0
        },
        "alignment": "default"
      }
    }
  },
  "answerArea": {
    "tTable": false,
    "zTable": false,
    "chi2Table": false,
    "calculator": false,
    "periodicTable": false
  },
  "itemDataVersion": {
    "major": 0,
    "minor": 1
  }
}
```

### Structured JSON (generated)
```json
{
  "body": [
    {
      "type": "blockSlot",
      "slotId": "image_1"
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "Amia went to a flower farm and picked "
        },
        {
          "type": "math",
          "mathml": "<mi>f</mi>"
        },
        {
          "type": "text",
          "content": " flowers. When she got home, she put the flowers in "
        },
        {
          "type": "math",
          "mathml": "<mn>4</mn>"
        },
        {
          "type": "text",
          "content": " vases, with "
        },
        {
          "type": "math",
          "mathml": "<mn>22</mn>"
        },
        {
          "type": "text",
          "content": " flowers in each vase."
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "Write an equation to describe this situation."
        },
        {
          "type": "text",
          "content": " "
        },
        {
          "type": "inlineSlot",
          "slotId": "expression_3"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "How many flowers did Amia pick at the farm? "
        },
        {
          "type": "inlineSlot",
          "slotId": "numeric_input_1"
        }
      ]
    }
  ],
  "title": "Flowers in vases: write an equation and find the total",
  "widgets": {
    "image_1": {
      "size": 128,
      "type": "emojiImage",
      "emoji": "ðŸŒ¸",
      "label": "Flower"
    }
  },
  "feedback": {
    "correct": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Correct! One valid equation is "
          },
          {
            "type": "math",
            "mathml": "<mfrac><mi>f</mi><mn>22</mn></mfrac><mo>=</mo><mn>4</mn>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Therefore, Amia picked "
          },
          {
            "type": "math",
            "mathml": "<mn>88</mn>"
          },
          {
            "type": "text",
            "content": " flowers."
          }
        ]
      }
    ],
    "incorrect": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Not quite. Relate the number of vases, total flowers, and flowers per vase. The number of vases equals total divided by flowers per vase: "
          },
          {
            "type": "math",
            "mathml": "<mn>4</mn><mo>=</mo><mfrac><mi>f</mi><mn>22</mn></mfrac>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Multiply both sides by "
          },
          {
            "type": "math",
            "mathml": "<mn>22</mn>"
          },
          {
            "type": "text",
            "content": " to solve for "
          },
          {
            "type": "math",
            "mathml": "<mi>f</mi>"
          },
          {
            "type": "text",
            "content": ": "
          },
          {
            "type": "math",
            "mathml": "<mi>f</mi><mo>=</mo><mn>88</mn>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ]
  },
  "identifier": "amia-flowers-equation-and-count",
  "interactions": {
    "expression_3": {
      "type": "textEntryInteraction",
      "expectedLength": 8,
      "responseIdentifier": "RESPONSE_EQ"
    },
    "numeric_input_1": {
      "type": "textEntryInteraction",
      "expectedLength": 3,
      "responseIdentifier": "RESPONSE_NUM"
    }
  },
  "responseDeclarations": [
    {
      "correct": "f/22=4",
      "baseType": "string",
      "identifier": "RESPONSE_EQ",
      "cardinality": "single"
    },
    {
      "correct": 88,
      "baseType": "integer",
      "identifier": "RESPONSE_NUM",
      "cardinality": "single"
    }
  ]
}
```

### Relevant code
- Response normalization â€” src/lib/qti-generation/response-processor.ts
```
import { isTerminatingFraction } from "./helpers"
import type { AssessmentItem } from "./schemas"

export function compileResponseDeclarations(decls: AssessmentItem["responseDeclarations"]): string {
	// Guardrail: ensure identifier-base declarations use choice identifiers, not labels
	for (const decl of decls) {
		if (decl.baseType === "identifier") {
			const correctValues = Array.isArray(decl.correct) ? decl.correct : [decl.correct]
			const offending = correctValues.filter((v): v is string => typeof v === "string" && /\s/.test(v))
			if (offending.length > 0) {
				logger.error("identifier response contains non-identifier values", {
					responseIdentifier: decl.identifier,
					offending
				})
				throw errors.new(
					`response '${decl.identifier}' expects choice identifier(s); found label-like value(s): [${offending.join(", ")}]`
				)
			}
		}
	}

	// Pre-process declarations to add equivalent numeric mappings.
	return decls
		.map((decl) => {
			const correctValues = Array.isArray(decl.correct) ? decl.correct : [decl.correct]
			const allCorrectValues = new Set<string | number>(correctValues)

			for (const val of correctValues) {
				if (typeof val !== "string") continue

				if (val.startsWith(".")) allCorrectValues.add(`0${val}`)
				else if (val.startsWith("0.")) allCorrectValues.add(val.substring(1))

				// Rule: Allow implicit multiplication between a leading numeric coefficient and parentheses
				// e.g., 25*(p+2q) -> also accept 25(p+2q)
				{
					const implicitAlt = val.replace(/(\d+)\s*\*\s*\(/g, "$1(")
					if (implicitAlt !== val) {
						allCorrectValues.add(implicitAlt)
					}
				}

				if (val.includes("/") && !val.startsWith(".")) {
					const parts = val.split("/")
					if (parts.length === 2 && parts[0] && parts[1]) {
						const num = Number.parseInt(parts[0], 10)
```

- Graphie URL fixer (stimulus) â€” src/lib/qti-generation/xml-fixes.ts
```
 * @param logger The logger instance
 * @returns The XML string with properly formatted Khan graphie URLs
 */
export function fixKhanGraphieUrls(xml: string, logger: logger.Logger): string {
	// Match Khan graphie URLs that don't already have a file extension
	// Named capture groups for clarity
	const khanGraphieRegex =
		/(?<url>https:\/\/cdn\.kastatic\.org\/ka-perseus-graphie\/(?<hash>[a-zA-Z0-9]+))(?!\.(?:svg|png|jpg|jpeg|gif|webp))(?<after>[\s"'<>&]|$)/g

	let fixCount = 0

	const fixedXml = xml.replace(khanGraphieRegex, (_match, url, _hash, after) => {
		fixCount++
		return `${url}.svg${after}`
	})

	if (fixCount > 0) {
		logger.debug("fixed khan graphie urls by appending .svg", {
			fixCount,
			originalLength: xml.length,
			fixedLength: fixedXml.length
		})
	}

	return fixedXml
}

/**
 * MISSION CRITICAL: Fixes unescaped inequality operators throughout the XML.
 * - For qti-value elements: Escapes to HTML entities (&lt;= and &gt;=) for ASCII input
 * - For all other content: Converts to Unicode symbols (â‰¤ and â‰¥) for proper display
 *
 * This function uses EXTREMELY robust named capture groups and multiple safeguards
 * to ensure it NEVER corrupts valid XML.
 *
 * @param xml The XML string to process
 * @param logger The logger instance
 * @returns The XML string with properly handled inequality operators
 */
export function fixInequalityOperators(xml: string, logger: logger.Logger): string {
	let totalFixCount = 0

	// CRITICAL: Only process qti-value elements that contain mathematical inequalities
	// This regex uses named capture groups for maximum clarity and robustness
	const qtiValueRegex = new RegExp(
		// Opening tag with exact match
```

- Perseus image resolver â€” src/lib/qti-generation/structured/perseus-image-resolver.ts
```
export interface ImageContext {
	rasterImageUrls: string[]
	svgContentMap: Map<string, string>
	resolvedUrlMap: Map<string, string>
}

async function resolvePerseusUrl(baseUrl: string): Promise<{ resolvedUrl: string; type: ImageType } | undefined> {
	for (const ext of SUPPORTED_EXTENSIONS) {
		const urlWithExt = `${baseUrl}.${ext}`
		const result = await errors.try(fetch(urlWithExt, { method: "HEAD", signal: AbortSignal.timeout(5000) }))
		if (!result.error && result.data.ok) {
			logger.debug("successfully resolved perseus url", { originalUrl: baseUrl, resolvedUrl: urlWithExt })
			return { resolvedUrl: urlWithExt, type: ext }
		}
	}
	return undefined
}

function findPerseusUrls(obj: unknown, urls: Set<string>): void {
	if (typeof obj !== "object" || obj === null) return
	if (Array.isArray(obj)) {
		for (const item of obj) findPerseusUrls(item, urls)
		return
	}
	for (const [key, value] of Object.entries(obj)) {
		if (key === "url" && typeof value === "string" && value.startsWith("web+graphie://")) {
			urls.add(value)
		} else {
			findPerseusUrls(value, urls)
		}
	}
}

export async function buildImageContext(perseusData: unknown): Promise<ImageContext> {
	logger.debug("starting perseus url resolution for ai context")
	const originalUrls = new Set<string>()
	findPerseusUrls(perseusData, originalUrls)

	const context: ImageContext = {
		rasterImageUrls: [],
		svgContentMap: new Map(),
		resolvedUrlMap: new Map()
	}

	if (originalUrls.size === 0) {
		logger.debug("no perseus urls found to resolve")
```

- Compiler finalization (missing URL hardening) â€” src/lib/qti-generation/compiler.ts
```
	finalXml = stripXmlComments(finalXml, logger)
	finalXml = removeDoubleNewlines(finalXml, logger)
	finalXml = fixMathMLOperators(finalXml, logger)
	finalXml = fixInequalityOperators(finalXml, logger)
	// Convert HTML entities to Unicode characters at the very end
	return convertHtmlEntities(finalXml, logger)
}

```
