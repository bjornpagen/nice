# Compare sqrt(13) and 15/4

- **analysisId**: c241ab6e-38ea-4ae3-9cd4-33f5f6c3c785
- **questionId**: x6114c9f989526b4a
- **severity**: major

### Issue
The question correctly includes a dropdown for selecting an inequality operator, however, it incorrectly also includes a multiple choice selection with answer choices "A" and "B".

### Perseus (original)
```json
{
  "hints": [
    {
      "images": {},
      "content": "Let's convert each number to decimal form.",
      "widgets": {}
    },
    {
      "images": {},
      "content": ">$\\blue{\\sqrt{13}}\\approx 3.61$\n",
      "widgets": {}
    },
    {
      "images": {},
      "content": ">$\\pink{\\dfrac{15}4}= 3.75$",
      "widgets": {}
    },
    {
      "images": {},
      "content": ">$\\blue{\\sqrt{13}}<\\pink{\\dfrac{15}4}$",
      "widgets": {}
    }
  ],
  "question": {
    "images": {},
    "content": "**Compare.**\n\n$\\sqrt{13}~$   [[☃ dropdown 1]] $~\\dfrac{15}4$",
    "widgets": {
      "radio 1": {
        "type": "radio",
        "graded": true,
        "options": {
          "choices": [
            {
              "content": "$A$",
              "correct": false
            },
            {
              "content": "$B$",
              "correct": true
            }
          ],
          "randomize": false,
          "onePerLine": true,
          "displayCount": null,
          "multipleSelect": false,
          "noneOfTheAbove": false,
          "deselectEnabled": false
        },
        "version": {
          "major": 0,
          "minor": 0
        }
      },
      "dropdown 1": {
        "type": "dropdown",
        "graded": true,
        "options": {
          "choices": [
            {
              "content": "<",
              "correct": true
            },
            {
              "content": ">",
              "correct": false
            },
            {
              "content": "=",
              "correct": false
            }
          ],
          "placeholder": ""
        },
        "version": {
          "major": 0,
          "minor": 0
        }
      }
    }
  },
  "answerArea": {
    "type": "multiple",
    "options": {
      "images": {},
      "content": "",
      "widgets": {}
    },
    "calculator": true
  },
  "itemDataVersion": {
    "major": 0,
    "minor": 1
  }
}
```

### Structured JSON (generated)
```json
{
  "body": [
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "Compare."
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "math",
          "mathml": "<msqrt><mn>13</mn></msqrt>"
        },
        {
          "type": "text",
          "content": " "
        },
        {
          "type": "inlineSlot",
          "slotId": "comparison_dropdown"
        },
        {
          "type": "text",
          "content": " "
        },
        {
          "type": "math",
          "mathml": "<mfrac><mn>15</mn><mn>4</mn></mfrac>"
        }
      ]
    },
    {
      "type": "blockSlot",
      "slotId": "choice_interaction_1"
    }
  ],
  "title": "Compare sqrt(13) and 15/4",
  "widgets": {},
  "feedback": {
    "correct": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Correct! Since "
          },
          {
            "type": "math",
            "mathml": "<msqrt><mn>13</mn></msqrt><mo>≈</mo><mn>3.61</mn>"
          },
          {
            "type": "text",
            "content": " and "
          },
          {
            "type": "math",
            "mathml": "<mfrac><mn>15</mn><mn>4</mn></mfrac><mo>=</mo><mn>3.75</mn>"
          },
          {
            "type": "text",
            "content": ", we have "
          },
          {
            "type": "math",
            "mathml": "<msqrt><mn>13</mn></msqrt><mo>&lt;</mo><mfrac><mn>15</mn><mn>4</mn></mfrac>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ],
    "incorrect": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Not quite. Let's convert each number to decimal form."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<msqrt><mn>13</mn></msqrt><mo>≈</mo><mn>3.61</mn>"
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<mfrac><mn>15</mn><mn>4</mn></mfrac><mo>=</mo><mn>3.75</mn>"
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<msqrt><mn>13</mn></msqrt><mo>&lt;</mo><mfrac><mn>15</mn><mn>4</mn></mfrac>"
          }
        ]
      }
    ]
  },
  "identifier": "compare-sqrt13-vs-15-4",
  "interactions": {
    "comparison_dropdown": {
      "type": "inlineChoiceInteraction",
      "choices": [
        {
          "content": [
            {
              "type": "math",
              "mathml": "<mo>&lt;</mo>"
            }
          ],
          "identifier": "LT"
        },
        {
          "content": [
            {
              "type": "math",
              "mathml": "<mo>&gt;</mo>"
            }
          ],
          "identifier": "GT"
        },
        {
          "content": [
            {
              "type": "math",
              "mathml": "<mo>=</mo>"
            }
          ],
          "identifier": "EQ"
        }
      ],
      "shuffle": true,
      "responseIdentifier": "RESP_COMP"
    },
    "choice_interaction_1": {
      "type": "choiceInteraction",
      "prompt": [
        {
          "type": "text",
          "content": "Select one option."
        }
      ],
      "choices": [
        {
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "math",
                  "mathml": "<mi>A</mi>"
                }
              ]
            }
          ],
          "feedback": null,
          "identifier": "A"
        },
        {
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "math",
                  "mathml": "<mi>B</mi>"
                }
              ]
            }
          ],
          "feedback": null,
          "identifier": "B"
        }
      ],
      "shuffle": true,
      "maxChoices": 1,
      "minChoices": 1,
      "responseIdentifier": "RESP_RADIO"
    }
  },
  "responseDeclarations": [
    {
      "correct": "LT",
      "baseType": "identifier",
      "identifier": "RESP_COMP",
      "cardinality": "single"
    },
    {
      "correct": "B",
      "baseType": "identifier",
      "identifier": "RESP_RADIO",
      "cardinality": "single"
    }
  ]
}
```

### Relevant code
- Response normalization — src/lib/qti-generation/response-processor.ts
```
import { isTerminatingFraction } from "./helpers"
import type { AssessmentItem } from "./schemas"

export function compileResponseDeclarations(decls: AssessmentItem["responseDeclarations"]): string {
	// Guardrail: ensure identifier-base declarations use choice identifiers, not labels
	for (const decl of decls) {
		if (decl.baseType === "identifier") {
			const correctValues = Array.isArray(decl.correct) ? decl.correct : [decl.correct]
			const offending = correctValues.filter((v): v is string => typeof v === "string" && /\s/.test(v))
			if (offending.length > 0) {
				logger.error("identifier response contains non-identifier values", {
					responseIdentifier: decl.identifier,
					offending
				})
				throw errors.new(
					`response '${decl.identifier}' expects choice identifier(s); found label-like value(s): [${offending.join(", ")}]`
				)
			}
		}
	}

	// Pre-process declarations to add equivalent numeric mappings.
	return decls
		.map((decl) => {
			const correctValues = Array.isArray(decl.correct) ? decl.correct : [decl.correct]
			const allCorrectValues = new Set<string | number>(correctValues)

			for (const val of correctValues) {
				if (typeof val !== "string") continue

				if (val.startsWith(".")) allCorrectValues.add(`0${val}`)
				else if (val.startsWith("0.")) allCorrectValues.add(val.substring(1))

				// Rule: Allow implicit multiplication between a leading numeric coefficient and parentheses
				// e.g., 25*(p+2q) -> also accept 25(p+2q)
				{
					const implicitAlt = val.replace(/(\d+)\s*\*\s*\(/g, "$1(")
					if (implicitAlt !== val) {
						allCorrectValues.add(implicitAlt)
					}
				}

				if (val.includes("/") && !val.startsWith(".")) {
					const parts = val.split("/")
					if (parts.length === 2 && parts[0] && parts[1]) {
						const num = Number.parseInt(parts[0], 10)
```

- Structured pipeline orchestration — src/lib/qti-generation/structured/client.ts
```
 * Main entry point for the structured pipeline: generateStructuredQtiItem.
 * This orchestrates the 4-shot process and merges the results.
 */
export async function generateStructuredQtiItem(
	logger: logger.Logger,
	perseusData: unknown
): Promise<AssessmentItemInput> {
	const perseusJsonString = JSON.stringify(perseusData, null, 2)
	logger.info("starting structured qti generation process")

	const imageContext = await buildImageContext(perseusData)

	// Shot 1: Generate the content shell and plan.
	logger.debug("shot 1: generating assessment shell")
	const shellResult = await errors.try(generateAssessmentShell(logger, perseusJsonString, imageContext))
	if (shellResult.error) {
		logger.error("shot 1 failed: shell generation pass failed", { error: shellResult.error })
		throw shellResult.error
	}
	const assessmentShell = shellResult.data
	logger.debug("shot 1 complete", {
		identifier: assessmentShell.identifier,
		widgetSlots: assessmentShell.widgets,
		interactionSlots: assessmentShell.interactions
	})

	// FIX: Replace the incomplete slot checker with a comprehensive one.
	logger.debug("validating consistency between declared slots and body content")

	function collectAllSlotIds(shell: AssessmentItemShell): Set<string> {
		const ids = new Set<string>()
		const _seenInteractions = new Set<string>()

		function walkInline(items: InlineContent | null | undefined) {
			if (!items) return
			for (const item of items) {
				if (item.type === "inlineSlot") ids.add(item.slotId)
			}
		}

		function walkBlock(items: BlockContent | null | undefined) {
			if (!items) return
			for (const item of items) {
				if (item.type === "blockSlot") ids.add(item.slotId)
				else if (item.type === "paragraph") walkInline(item.content)
			}
```

- Compiler finalization (missing URL hardening) — src/lib/qti-generation/compiler.ts
```
	finalXml = stripXmlComments(finalXml, logger)
	finalXml = removeDoubleNewlines(finalXml, logger)
	finalXml = fixMathMLOperators(finalXml, logger)
	finalXml = fixInequalityOperators(finalXml, logger)
	// Convert HTML entities to Unicode characters at the very end
	return convertHtmlEntities(finalXml, logger)
}

```
