# Find the measure of angle x

- **analysisId**: 4af53605-faac-4223-af0f-0d4751cd13a9
- **questionId**: x61c8b090cab03b39
- **severity**: minor

### Issue
The "O" point label should be on the bottom to ensure that the lines are not overlapping the label. The angle arcs should be farther away from the center point.

### Perseus (original)
```json
{
  "hints": [
    {
      "images": {},
      "content": "From the diagram, we see that $\\angle AOB$ and $\\angle BOC$ are complementary angles.",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "Therefore, $m \\angle AOB + m \\angle BOC = 90\\degree$.",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "$\\begin{align}\\angle AOB + \\angle BOC &= 90\\degree\n\\\\\\\\\n53+x &= 90 \\degree\n \\\\\\\\\nx &= 37\\degree \\end{align}$",
      "replace": false,
      "widgets": {}
    }
  ],
  "question": {
    "images": {},
    "content": "**What is the measure of $\\angle x$?**  \n*Angles are not necessarily drawn to scale.*\n\n[[☃ image 1]]\n\n\n\n$x = $ [[☃ numeric-input 1]] $\\Large{\\degree}$",
    "widgets": {
      "image 1": {
        "type": "image",
        "graded": true,
        "static": false,
        "options": {
          "alt": "Angle A O C is a right angle. Ray B O divides angle A O C into two parts. Angle A O B is labeled 53 degrees and Angle B O C is labeled X degrees.\n\n",
          "box": [
            216,
            162
          ],
          "range": [
            [
              0,
              10
            ],
            [
              0,
              10
            ]
          ],
          "title": "",
          "labels": [],
          "static": false,
          "caption": "",
          "backgroundImage": {
            "url": "web+graphie://cdn.kastatic.org/ka-perseus-graphie/125864788d908cbe396fdee70ff4ac54b2f2eecd",
            "width": 216,
            "height": 162
          }
        },
        "version": {
          "major": 0,
          "minor": 0
        },
        "alignment": "block"
      },
      "numeric-input 1": {
        "type": "numeric-input",
        "graded": true,
        "static": false,
        "options": {
          "size": "normal",
          "static": false,
          "answers": [
            {
              "value": 37,
              "status": "correct",
              "strict": false,
              "message": "",
              "maxError": 0,
              "simplify": "required"
            }
          ],
          "labelText": "",
          "rightAlign": false,
          "coefficient": false
        },
        "version": {
          "major": 0,
          "minor": 0
        },
        "alignment": "default"
      }
    }
  },
  "answerArea": {
    "tTable": false,
    "zTable": false,
    "chi2Table": false,
    "calculator": false,
    "periodicTable": false,
    "periodicTableWithKey": false,
    "financialCalculatorTotalAmount": false,
    "financialCalculatorTimeToPayOff": false,
    "financialCalculatorMonthlyPayment": false
  },
  "itemDataVersion": {
    "major": 0,
    "minor": 1
  }
}
```

### Structured JSON (generated)
```json
{
  "body": [
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "What is the measure of "
        },
        {
          "type": "math",
          "mathml": "<mo>∠</mo><mi>x</mi>"
        },
        {
          "type": "text",
          "content": "?"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "Angles are not necessarily drawn to scale."
        }
      ]
    },
    {
      "type": "blockSlot",
      "slotId": "image_1"
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "math",
          "mathml": "<mi>x</mi><mo>=</mo>"
        },
        {
          "type": "text",
          "content": " "
        },
        {
          "type": "inlineSlot",
          "slotId": "text_entry"
        },
        {
          "type": "text",
          "content": " "
        },
        {
          "type": "math",
          "mathml": "<mo>°</mo>"
        }
      ]
    }
  ],
  "title": "Find the measure of angle x",
  "widgets": {
    "image_1": {
      "rays": [
        {
          "to": "A",
          "from": "O"
        },
        {
          "to": "B",
          "from": "O"
        },
        {
          "to": "C",
          "from": "O"
        }
      ],
      "type": "angleDiagram",
      "width": 216,
      "angles": [
        {
          "color": "#000000",
          "label": "",
          "radius": 22,
          "vertices": [
            "A",
            "O",
            "C"
          ],
          "isRightAngle": true
        },
        {
          "color": "#000000",
          "label": "53°",
          "radius": 28,
          "vertices": [
            "A",
            "O",
            "B"
          ],
          "isRightAngle": false
        },
        {
          "color": "#000000",
          "label": "x",
          "radius": 36,
          "vertices": [
            "B",
            "O",
            "C"
          ],
          "isRightAngle": false
        }
      ],
      "height": 162,
      "points": [
        {
          "x": 102,
          "y": 138,
          "id": "O",
          "label": "O",
          "shape": "circle"
        },
        {
          "x": 24.865,
          "y": 46.075,
          "id": "A",
          "label": "A",
          "shape": "circle"
        },
        {
          "x": 128.994,
          "y": 21.076,
          "id": "B",
          "label": "B",
          "shape": "circle"
        },
        {
          "x": 193.925,
          "y": 60.865,
          "id": "C",
          "label": "C",
          "shape": "circle"
        }
      ]
    }
  },
  "feedback": {
    "correct": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Correct! Since "
          },
          {
            "type": "math",
            "mathml": "<mo>∠</mo><mi>A</mi><mi>O</mi><mi>B</mi>"
          },
          {
            "type": "text",
            "content": " and "
          },
          {
            "type": "math",
            "mathml": "<mo>∠</mo><mi>B</mi><mi>O</mi><mi>C</mi>"
          },
          {
            "type": "text",
            "content": " are complementary, "
          },
          {
            "type": "math",
            "mathml": "<mrow><mrow><mi>m</mi><mo>∠</mo><mi>A</mi><mi>O</mi><mi>B</mi></mrow><mo>+</mo><mrow><mi>m</mi><mo>∠</mo><mi>B</mi><mi>O</mi><mi>C</mi></mrow><mo>=</mo><mn>90</mn><mo>°</mo></mrow>"
          },
          {
            "type": "text",
            "content": ", so "
          },
          {
            "type": "math",
            "mathml": "<mn>53</mn><mo>+</mo><mi>x</mi><mo>=</mo><mn>90</mn><mo>°</mo>"
          },
          {
            "type": "text",
            "content": ", and "
          },
          {
            "type": "math",
            "mathml": "<mi>x</mi><mo>=</mo><mn>37</mn><mo>°</mo>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ],
    "incorrect": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Not quite. Use the fact that the two angles form a right angle."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "From the diagram, we see that "
          },
          {
            "type": "math",
            "mathml": "<mo>∠</mo><mi>A</mi><mi>O</mi><mi>B</mi>"
          },
          {
            "type": "text",
            "content": " and "
          },
          {
            "type": "math",
            "mathml": "<mo>∠</mo><mi>B</mi><mi>O</mi><mi>C</mi>"
          },
          {
            "type": "text",
            "content": " are complementary angles."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Therefore, "
          },
          {
            "type": "math",
            "mathml": "<mrow><mrow><mi>m</mi><mo>∠</mo><mi>A</mi><mi>O</mi><mi>B</mi></mrow><mo>+</mo><mrow><mi>m</mi><mo>∠</mo><mi>B</mi><mi>O</mi><mi>C</mi></mrow><mo>=</mo><mn>90</mn><mo>°</mo></mrow>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<mo>∠</mo><mi>A</mi><mi>O</mi><mi>B</mi><mo>+</mo><mo>∠</mo><mi>B</mi><mi>O</mi><mi>C</mi><mo>=</mo><mn>90</mn><mo>°</mo>"
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<mn>53</mn><mo>+</mo><mi>x</mi><mo>=</mo><mn>90</mn><mo>°</mo>"
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<mi>x</mi><mo>=</mo><mn>37</mn><mo>°</mo>"
          }
        ]
      }
    ]
  },
  "identifier": "measure-angle-x-complementary",
  "interactions": {
    "text_entry": {
      "type": "textEntryInteraction",
      "expectedLength": 2,
      "responseIdentifier": "RESPONSE"
    }
  },
  "responseDeclarations": [
    {
      "correct": 37,
      "baseType": "integer",
      "identifier": "RESPONSE",
      "cardinality": "single"
    }
  ]
}
```

### Relevant code
- Response normalization — src/lib/qti-generation/response-processor.ts
```
import { isTerminatingFraction } from "./helpers"
import type { AssessmentItem } from "./schemas"

export function compileResponseDeclarations(decls: AssessmentItem["responseDeclarations"]): string {
	// Guardrail: ensure identifier-base declarations use choice identifiers, not labels
	for (const decl of decls) {
		if (decl.baseType === "identifier") {
			const correctValues = Array.isArray(decl.correct) ? decl.correct : [decl.correct]
			const offending = correctValues.filter((v): v is string => typeof v === "string" && /\s/.test(v))
			if (offending.length > 0) {
				logger.error("identifier response contains non-identifier values", {
					responseIdentifier: decl.identifier,
					offending
				})
				throw errors.new(
					`response '${decl.identifier}' expects choice identifier(s); found label-like value(s): [${offending.join(", ")}]`
				)
			}
		}
	}

	// Pre-process declarations to add equivalent numeric mappings.
	return decls
		.map((decl) => {
			const correctValues = Array.isArray(decl.correct) ? decl.correct : [decl.correct]
			const allCorrectValues = new Set<string | number>(correctValues)

			for (const val of correctValues) {
				if (typeof val !== "string") continue

				if (val.startsWith(".")) allCorrectValues.add(`0${val}`)
				else if (val.startsWith("0.")) allCorrectValues.add(val.substring(1))

				// Rule: Allow implicit multiplication between a leading numeric coefficient and parentheses
				// e.g., 25*(p+2q) -> also accept 25(p+2q)
				{
					const implicitAlt = val.replace(/(\d+)\s*\*\s*\(/g, "$1(")
					if (implicitAlt !== val) {
						allCorrectValues.add(implicitAlt)
					}
				}

				if (val.includes("/") && !val.startsWith(".")) {
					const parts = val.split("/")
					if (parts.length === 2 && parts[0] && parts[1]) {
						const num = Number.parseInt(parts[0], 10)
```

- Widget registry — src/lib/widgets/generators/index.ts
```
import { generateVennDiagram, VennDiagramPropsSchema } from "./venn-diagram"
import { generateVerticalArithmeticSetup, VerticalArithmeticSetupPropsSchema } from "./vertical-arithmetic-setup"

// The `type` field is now included in the base schemas, so we remove .extend()
export const typedSchemas = {
	"3dIntersectionDiagram": ThreeDIntersectionDiagramPropsSchema,
	absoluteValueNumberLine: AbsoluteValueNumberLinePropsSchema,
	angleDiagram: AngleDiagramPropsSchema,
	barChart: BarChartPropsSchema,
	boxGrid: BoxGridPropsSchema,
	boxPlot: BoxPlotPropsSchema,
	circleDiagram: CircleDiagramPropsSchema,
	compositeShapeDiagram: CompositeShapeDiagramPropsSchema,
	coordinatePlane: CoordinatePlaneComprehensivePropsSchema,
	distanceFormulaGraph: DistanceFormulaGraphPropsSchema,
	functionPlotGraph: FunctionPlotGraphPropsSchema,
	lineEquationGraph: LineEquationGraphPropsSchema,
	pointPlotGraph: PointPlotGraphPropsSchema,
	polygonGraph: PolygonGraphPropsSchema,
	shapeTransformationGraph: ShapeTransformationGraphPropsSchema,
	dataTable: DataTablePropsSchema,
	discreteObjectRatioDiagram: DiscreteObjectRatioDiagramPropsSchema,
	dotPlot: DotPlotPropsSchema,
	doubleNumberLine: DoubleNumberLinePropsSchema,
	emojiImage: EmojiImagePropsSchema,
	figureComparisonDiagram: FigureComparisonDiagramPropsSchema,
	fractionNumberLine: FractionNumberLinePropsSchema,
	geometricSolidDiagram: GeometricSolidDiagramPropsSchema,
	hangerDiagram: HangerDiagramPropsSchema,
	histogram: HistogramPropsSchema,
	inequalityNumberLine: InequalityNumberLinePropsSchema,
	numberLine: NumberLinePropsSchema,
	numberLineForOpposites: NumberLineForOppositesPropsSchema,
	numberLineWithAction: NumberLineWithActionPropsSchema,
	numberLineWithFractionGroups: NumberLineWithFractionGroupsPropsSchema,
	numberSetDiagram: NumberSetDiagramPropsSchema,
	partitionedShape: PartitionedShapePropsSchema,
	pentagonIntersectionDiagram: PentagonIntersectionDiagramPropsSchema,
	pictograph: PictographPropsSchema,
	polyhedronDiagram: PolyhedronDiagramPropsSchema,
	probabilitySpinner: ProbabilitySpinnerPropsSchema,
	polyhedronNetDiagram: PolyhedronNetDiagramPropsSchema,
	pythagoreanProofDiagram: PythagoreanProofDiagramPropsSchema,
	ratioBoxDiagram: RatioBoxDiagramPropsSchema,
	rectangularFrameDiagram: RectangularFrameDiagramPropsSchema,
	scaleCopiesSlider: ScaleCopiesSliderPropsSchema,
```

- Compiler finalization (missing URL hardening) — src/lib/qti-generation/compiler.ts
```
	finalXml = stripXmlComments(finalXml, logger)
	finalXml = removeDoubleNewlines(finalXml, logger)
	finalXml = fixMathMLOperators(finalXml, logger)
	finalXml = fixInequalityOperators(finalXml, logger)
	// Convert HTML entities to Unicode characters at the very end
	return convertHtmlEntities(finalXml, logger)
}

```
