# Find the value of x in similar figures

- **analysisId**: 91e3af78-0320-4c43-9293-b230502af192
- **questionId**: x620d99a9f250b1fd
- **severity**: patch

### Issue
The text for each figure should be colored with the associated shape's color.

### Perseus (original)
```json
{
  "hints": [
    {
      "images": {},
      "content": "The two quadrilaterals are drawn to scale, so we can find a ratio relating corresponding sides. We can use the ratio to find  $\\blueD{x}$. ",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "Let's identify corresponding sides.\n\nThe side length of  $\\blueD{30}$ units on $\\blueD{\\text{Figure A}}$ corresponds to the side length of $\\greenD{25}$ units on $\\greenD{\\text{Figure B}}$.",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "Let's find $\\blueD{x}$ using our corresponding sides $\\blueD{30}:\\greenD{25}$ and the side length $\\greenD{10}$.\n\n$\\blue{A}$ | $\\green{B}$\n:-:|:-:\n$\\blue{30}$ | $\\green{25}$\n$\\downarrow \\times \\dfrac{2}{5}$ | $\\downarrow \\times \\dfrac{2}{5}$\n$\\blue{x}$ | $\\green{10}$\n\nIf a side length in figure $\\greenD{B}$ is $\\dfrac{2}{5}$ times as long, then we also need to multiply the corresponding side length in figure $\\blueD{A}$ by $\\dfrac{2}{5}$.",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "The value of $\\blueD{x}$ is $\\blueD{12}$.",
      "replace": false,
      "widgets": {}
    }
  ],
  "question": {
    "images": {},
    "content": "Figure $A$ is a scale image of Figure $B$.\n\n[[☃ image 1]]\n\n**What is the value of $x$?**\n\n[[☃ numeric-input 1]]",
    "widgets": {
      "image 1": {
        "type": "image",
        "graded": true,
        "static": false,
        "options": {
          "alt": "Two same-shaped quadrilaterals labeled as Figure A and Figure B are shown side by side. Figure A is larger than Figure B. In Figure A, two sides measure 30 units and x units, and the corresponding sides in Figure B measure 25 units and 10 units.\n",
          "box": [
            265,
            149
          ],
          "range": [
            [
              0,
              10
            ],
            [
              0,
              10
            ]
          ],
          "title": "",
          "labels": [],
          "static": false,
          "caption": "",
          "backgroundImage": {
            "url": "web+graphie://cdn.kastatic.org/ka-perseus-graphie/698ab0c0acdcf335f12261a42ffccddcc2cbaf30",
            "width": 265,
            "height": 149
          }
        },
        "version": {
          "major": 0,
          "minor": 0
        },
        "alignment": "block"
      },
      "numeric-input 1": {
        "type": "numeric-input",
        "graded": true,
        "static": false,
        "options": {
          "size": "normal",
          "static": false,
          "answers": [
            {
              "value": 12,
              "status": "correct",
              "strict": false,
              "message": "",
              "maxError": null,
              "simplify": "required"
            }
          ],
          "labelText": "value of x",
          "rightAlign": false,
          "coefficient": false,
          "multipleNumberInput": false
        },
        "version": {
          "major": 0,
          "minor": 0
        },
        "alignment": "default"
      }
    }
  },
  "answerArea": {
    "tTable": false,
    "zTable": false,
    "chi2Table": false,
    "calculator": true,
    "periodicTable": false,
    "periodicTableWithKey": false,
    "financialCalculatorTotalAmount": false,
    "financialCalculatorTimeToPayOff": false,
    "financialCalculatorMonthlyPayment": false
  },
  "itemDataVersion": {
    "major": 0,
    "minor": 1
  }
}
```

### Structured JSON (generated)
```json
{
  "body": [
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "Figure A is a scale image of Figure B."
        }
      ]
    },
    {
      "type": "blockSlot",
      "slotId": "image_1"
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "What is the value of "
        },
        {
          "type": "math",
          "mathml": "<mi>x</mi>"
        },
        {
          "type": "text",
          "content": "? "
        },
        {
          "type": "inlineSlot",
          "slotId": "numeric_input_1"
        }
      ]
    }
  ],
  "title": "Find the value of x in similar figures",
  "widgets": {
    "image_1": {
      "type": "figureComparisonDiagram",
      "width": 265,
      "height": 149.063,
      "layout": "horizontal",
      "figures": [
        {
          "vertices": [
            {
              "x": 99.375,
              "y": 16.563
            },
            {
              "x": 16.562,
              "y": 49.687
            },
            {
              "x": 16.562,
              "y": 82.813
            },
            {
              "x": 49.688,
              "y": 82.813
            }
          ],
          "fillColor": "rgba(17, 172, 205, 0.08)",
          "sideLabels": [
            "30",
            "",
            "x",
            ""
          ],
          "figureLabel": {
            "text": "Figure A",
            "offset": 12,
            "position": "top"
          },
          "strokeColor": "#11accd",
          "strokeWidth": 2,
          "sideLabelOffset": 10
        },
        {
          "vertices": [
            {
              "x": 215.312,
              "y": 66.25
            },
            {
              "x": 146.302,
              "y": 93.854
            },
            {
              "x": 146.302,
              "y": 121.458
            },
            {
              "x": 173.906,
              "y": 121.458
            }
          ],
          "fillColor": "rgba(31, 171, 84, 0.08)",
          "sideLabels": [
            "25",
            "",
            "10",
            ""
          ],
          "figureLabel": {
            "text": "Figure B",
            "offset": 12,
            "position": "top"
          },
          "strokeColor": "#1fab54",
          "strokeWidth": 2,
          "sideLabelOffset": 10
        }
      ],
      "spacing": 24
    }
  },
  "feedback": {
    "correct": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Correct! The value of "
          },
          {
            "type": "math",
            "mathml": "<mi>x</mi>"
          },
          {
            "type": "text",
            "content": " is "
          },
          {
            "type": "math",
            "mathml": "<mn>12</mn>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Since corresponding sides are proportional, the scale factor from Figure A to Figure B is "
          },
          {
            "type": "math",
            "mathml": "<mfrac><mn>25</mn><mn>30</mn></mfrac>"
          },
          {
            "type": "text",
            "content": ". Therefore, "
          },
          {
            "type": "math",
            "mathml": "<mn>10</mn><mo>=</mo><mfrac><mn>25</mn><mn>30</mn></mfrac><mi>x</mi>"
          },
          {
            "type": "text",
            "content": ", so "
          },
          {
            "type": "math",
            "mathml": "<mi>x</mi><mo>=</mo><mn>12</mn>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ],
    "incorrect": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "The two quadrilaterals are drawn to scale, so corresponding sides have a constant ratio."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "The side of length "
          },
          {
            "type": "math",
            "mathml": "<mn>30</mn>"
          },
          {
            "type": "text",
            "content": " units in Figure A corresponds to the side of length "
          },
          {
            "type": "math",
            "mathml": "<mn>25</mn>"
          },
          {
            "type": "text",
            "content": " units in Figure B. The side of length "
          },
          {
            "type": "math",
            "mathml": "<mi>x</mi>"
          },
          {
            "type": "text",
            "content": " in Figure A corresponds to the side of length "
          },
          {
            "type": "math",
            "mathml": "<mn>10</mn>"
          },
          {
            "type": "text",
            "content": " in Figure B."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Find the scale factor from Figure A to Figure B: "
          },
          {
            "type": "math",
            "mathml": "<mfrac><mn>25</mn><mn>30</mn></mfrac><mo>=</mo><mfrac><mn>5</mn><mn>6</mn></mfrac>"
          },
          {
            "type": "text",
            "content": ". Then set up the proportion "
          },
          {
            "type": "math",
            "mathml": "<mn>10</mn><mo>=</mo><mfrac><mn>5</mn><mn>6</mn></mfrac><mi>x</mi>"
          },
          {
            "type": "text",
            "content": " and solve to get "
          },
          {
            "type": "math",
            "mathml": "<mi>x</mi><mo>=</mo><mn>12</mn>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ]
  },
  "identifier": "similar-quadrilaterals-find-x",
  "interactions": {
    "numeric_input_1": {
      "type": "textEntryInteraction",
      "expectedLength": 2,
      "responseIdentifier": "RESPONSE"
    }
  },
  "responseDeclarations": [
    {
      "correct": 12,
      "baseType": "integer",
      "identifier": "RESPONSE",
      "cardinality": "single"
    }
  ]
}
```

### Relevant code
- Widget registry — src/lib/widgets/generators/index.ts
```
import { generateVennDiagram, VennDiagramPropsSchema } from "./venn-diagram"
import { generateVerticalArithmeticSetup, VerticalArithmeticSetupPropsSchema } from "./vertical-arithmetic-setup"

// The `type` field is now included in the base schemas, so we remove .extend()
export const typedSchemas = {
	"3dIntersectionDiagram": ThreeDIntersectionDiagramPropsSchema,
	absoluteValueNumberLine: AbsoluteValueNumberLinePropsSchema,
	angleDiagram: AngleDiagramPropsSchema,
	barChart: BarChartPropsSchema,
	boxGrid: BoxGridPropsSchema,
	boxPlot: BoxPlotPropsSchema,
	circleDiagram: CircleDiagramPropsSchema,
	compositeShapeDiagram: CompositeShapeDiagramPropsSchema,
	coordinatePlane: CoordinatePlaneComprehensivePropsSchema,
	distanceFormulaGraph: DistanceFormulaGraphPropsSchema,
	functionPlotGraph: FunctionPlotGraphPropsSchema,
	lineEquationGraph: LineEquationGraphPropsSchema,
	pointPlotGraph: PointPlotGraphPropsSchema,
	polygonGraph: PolygonGraphPropsSchema,
	shapeTransformationGraph: ShapeTransformationGraphPropsSchema,
	dataTable: DataTablePropsSchema,
	discreteObjectRatioDiagram: DiscreteObjectRatioDiagramPropsSchema,
	dotPlot: DotPlotPropsSchema,
	doubleNumberLine: DoubleNumberLinePropsSchema,
	emojiImage: EmojiImagePropsSchema,
	figureComparisonDiagram: FigureComparisonDiagramPropsSchema,
	fractionNumberLine: FractionNumberLinePropsSchema,
	geometricSolidDiagram: GeometricSolidDiagramPropsSchema,
	hangerDiagram: HangerDiagramPropsSchema,
	histogram: HistogramPropsSchema,
	inequalityNumberLine: InequalityNumberLinePropsSchema,
	numberLine: NumberLinePropsSchema,
	numberLineForOpposites: NumberLineForOppositesPropsSchema,
	numberLineWithAction: NumberLineWithActionPropsSchema,
	numberLineWithFractionGroups: NumberLineWithFractionGroupsPropsSchema,
	numberSetDiagram: NumberSetDiagramPropsSchema,
	partitionedShape: PartitionedShapePropsSchema,
	pentagonIntersectionDiagram: PentagonIntersectionDiagramPropsSchema,
	pictograph: PictographPropsSchema,
	polyhedronDiagram: PolyhedronDiagramPropsSchema,
	probabilitySpinner: ProbabilitySpinnerPropsSchema,
	polyhedronNetDiagram: PolyhedronNetDiagramPropsSchema,
	pythagoreanProofDiagram: PythagoreanProofDiagramPropsSchema,
	ratioBoxDiagram: RatioBoxDiagramPropsSchema,
	rectangularFrameDiagram: RectangularFrameDiagramPropsSchema,
	scaleCopiesSlider: ScaleCopiesSliderPropsSchema,
```

- Compiler finalization (missing URL hardening) — src/lib/qti-generation/compiler.ts
```
	finalXml = stripXmlComments(finalXml, logger)
	finalXml = removeDoubleNewlines(finalXml, logger)
	finalXml = fixMathMLOperators(finalXml, logger)
	finalXml = fixInequalityOperators(finalXml, logger)
	// Convert HTML entities to Unicode characters at the very end
	return convertHtmlEntities(finalXml, logger)
}

```

### Root cause analysis
- Widget generators lack fine-grained layout controls for label spacing, tick sizing, and overlays (e.g., best-fit lines).
- Some required annotations (e.g., heights, arcs) aren’t dynamically computed or placed to avoid overlaps.

### Proposed fixes
- Add layout parameters (label offsets, min separation, collision avoidance) and derive sensible defaults per widget.
- Implement overlay support (e.g., regression line) where pedagogy demands it.
- Introduce visual QA validators to detect unreadable overlaps or missing required annotations.
