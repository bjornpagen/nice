# Compare a decimal and a square root

- **analysisId**: 80927f64-d978-4e11-a6dc-0d348329ba8d
- **questionId**: x0f408f2467c19801
- **severity**: major

### Issue
none of the responses enable the question to be answered. they are ALL WRONG.

### Perseus (original)
```json
{
  "hints": [
    {
      "images": {},
      "content": "Let's convert $\\blue{-\\sqrt{42}}$ to decimal form.",
      "widgets": {}
    },
    {
      "images": {},
      "content": ">$\\blue{-\\sqrt{42}}\\approx -6.48$",
      "widgets": {}
    },
    {
      "images": {},
      "content": ">$-6.9<\\blue{-\\sqrt{42}}$",
      "widgets": {}
    }
  ],
  "question": {
    "images": {},
    "content": "**Compare.**\n\n$-6.9~$   [[☃ dropdown 1]] $-\\sqrt{42}$",
    "widgets": {
      "radio 1": {
        "type": "radio",
        "graded": true,
        "options": {
          "choices": [
            {
              "content": "$A$",
              "correct": false
            },
            {
              "content": "$B$",
              "correct": true
            }
          ],
          "randomize": false,
          "onePerLine": true,
          "displayCount": null,
          "multipleSelect": false,
          "noneOfTheAbove": false,
          "deselectEnabled": false
        },
        "version": {
          "major": 0,
          "minor": 0
        }
      },
      "dropdown 1": {
        "type": "dropdown",
        "graded": true,
        "options": {
          "choices": [
            {
              "content": "<",
              "correct": true
            },
            {
              "content": ">",
              "correct": false
            },
            {
              "content": "=",
              "correct": false
            }
          ],
          "placeholder": ""
        },
        "version": {
          "major": 0,
          "minor": 0
        }
      }
    }
  },
  "answerArea": {
    "type": "multiple",
    "options": {
      "images": {},
      "content": "",
      "widgets": {}
    },
    "calculator": true
  },
  "itemDataVersion": {
    "major": 0,
    "minor": 1
  }
}
```

### Structured JSON (generated)
```json
{
  "body": [
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "Compare."
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "math",
          "mathml": "<mo>-</mo><mn>6.9</mn>"
        },
        {
          "type": "text",
          "content": " "
        },
        {
          "type": "inlineSlot",
          "slotId": "dropdown_1"
        },
        {
          "type": "text",
          "content": " "
        },
        {
          "type": "math",
          "mathml": "<mo>-</mo><msqrt><mn>42</mn></msqrt>"
        }
      ]
    }
  ],
  "title": "Compare a decimal and a square root",
  "widgets": {},
  "feedback": {
    "correct": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Correct! Since "
          },
          {
            "type": "math",
            "mathml": "<mo>-</mo><msqrt><mn>42</mn></msqrt><mo>≈</mo><mo>-</mo><mn>6.48</mn>"
          },
          {
            "type": "text",
            "content": " and "
          },
          {
            "type": "math",
            "mathml": "<mo>-</mo><mn>6.9</mn>"
          },
          {
            "type": "text",
            "content": " is less than "
          },
          {
            "type": "math",
            "mathml": "<mo>-</mo><mn>6.48</mn>"
          },
          {
            "type": "text",
            "content": ", the correct comparison is "
          },
          {
            "type": "math",
            "mathml": "<mo>-</mo><mn>6.9</mn><mo>&lt;</mo><mo>-</mo><msqrt><mn>42</mn></msqrt>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ],
    "incorrect": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Not quite. First convert the square root to a decimal."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<mo>-</mo><msqrt><mn>42</mn></msqrt><mo>≈</mo><mo>-</mo><mn>6.48</mn>"
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Then compare: "
          },
          {
            "type": "math",
            "mathml": "<mo>-</mo><mn>6.9</mn><mo>&lt;</mo><mo>-</mo><mn>6.48</mn>"
          },
          {
            "type": "text",
            "content": ", so "
          },
          {
            "type": "math",
            "mathml": "<mo>-</mo><mn>6.9</mn><mo>&lt;</mo><mo>-</mo><msqrt><mn>42</mn></msqrt>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ]
  },
  "identifier": "compare-decimal-and-sqrt-dropdown",
  "interactions": {
    "dropdown_1": {
      "type": "inlineChoiceInteraction",
      "choices": [
        {
          "content": [
            {
              "type": "text",
              "content": "<"
            }
          ],
          "identifier": "<"
        },
        {
          "content": [
            {
              "type": "text",
              "content": ">"
            }
          ],
          "identifier": ">"
        },
        {
          "content": [
            {
              "type": "text",
              "content": "="
            }
          ],
          "identifier": "="
        }
      ],
      "shuffle": true,
      "responseIdentifier": "RESPONSE"
    }
  },
  "responseDeclarations": [
    {
      "correct": "<",
      "baseType": "string",
      "identifier": "RESPONSE",
      "cardinality": "single"
    }
  ]
}
```

### Relevant code
- Structured pipeline orchestration — src/lib/qti-generation/structured/client.ts
```
 * Main entry point for the structured pipeline: generateStructuredQtiItem.
 * This orchestrates the 4-shot process and merges the results.
 */
export async function generateStructuredQtiItem(
	logger: logger.Logger,
	perseusData: unknown
): Promise<AssessmentItemInput> {
	const perseusJsonString = JSON.stringify(perseusData, null, 2)
	logger.info("starting structured qti generation process")

	const imageContext = await buildImageContext(perseusData)

	// Shot 1: Generate the content shell and plan.
	logger.debug("shot 1: generating assessment shell")
	const shellResult = await errors.try(generateAssessmentShell(logger, perseusJsonString, imageContext))
	if (shellResult.error) {
		logger.error("shot 1 failed: shell generation pass failed", { error: shellResult.error })
		throw shellResult.error
	}
	const assessmentShell = shellResult.data
	logger.debug("shot 1 complete", {
		identifier: assessmentShell.identifier,
		widgetSlots: assessmentShell.widgets,
		interactionSlots: assessmentShell.interactions
	})

	// FIX: Replace the incomplete slot checker with a comprehensive one.
	logger.debug("validating consistency between declared slots and body content")

	function collectAllSlotIds(shell: AssessmentItemShell): Set<string> {
		const ids = new Set<string>()
		const _seenInteractions = new Set<string>()

		function walkInline(items: InlineContent | null | undefined) {
			if (!items) return
			for (const item of items) {
				if (item.type === "inlineSlot") ids.add(item.slotId)
			}
		}

		function walkBlock(items: BlockContent | null | undefined) {
			if (!items) return
			for (const item of items) {
				if (item.type === "blockSlot") ids.add(item.slotId)
				else if (item.type === "paragraph") walkInline(item.content)
			}
```

- Compiler finalization (missing URL hardening) — src/lib/qti-generation/compiler.ts
```
	finalXml = stripXmlComments(finalXml, logger)
	finalXml = removeDoubleNewlines(finalXml, logger)
	finalXml = fixMathMLOperators(finalXml, logger)
	finalXml = fixInequalityOperators(finalXml, logger)
	// Convert HTML entities to Unicode characters at the very end
	return convertHtmlEntities(finalXml, logger)
}

```

### Root cause analysis
- Shell mapping may introduce spurious interactions; slot consistency is internal-only and doesn’t validate against Perseus intent.
- AI mapping can misclassify needed interaction types, yielding unanswerable or contradictory responses.

### Proposed fixes
- Add a Perseus-intent alignment pass: verify interactions match source intent and forbid extraneous interaction creation.
- Constrain the mapping prompt with explicit allowed interaction set inferred from Perseus widget types.
- Validation: assert that responseDeclarations map 1:1 to required interactions and that choices are answerable.
