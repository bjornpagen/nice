# Identify the first mistake in solving an equation

- **analysisId**: 47cbc16b-549a-4fe8-b001-b5b71d3f9986
- **questionId**: xff6cd45b69dced1f
- **severity**: patch

### Issue
The question should never be in the qti-body, and always in the qti-prompt. cannot have this redundancy

### Perseus (original)
```json
{
  "hints": [
    {
      "images": {},
      "content": "###Strategy\n\nTo $\\tealE{\\text{set up}}$ the equation for solving, Nasir needs to perform the same operation on both sides of the equation.\n\nTo $\\purpleD{\\text{calculate}}$ the solution, Nasir needs to correctly solve the equation he $\\tealE{\\text{set up}}$.\n\nIf Nasir both $\\tealE{\\text{set up}}$ and $\\purpleD{\\text{calculated}}$ the solution correctly, then he correctly solved the equation.",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "When $\\tealE{\\text{setting up}}$ the equation for solving, Nasir subtracted $2$ from the left side of the equation and added $2$ to the right side of the equation.\n\nThis is a mistake!\n\nNasir should have added $2$ to both sides of the equation.",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "###Answer\n\nNasir's first mistake was in $\\tealE{\\text{setting up}}$.",
      "replace": false,
      "widgets": {}
    }
  ],
  "question": {
    "images": {},
    "content": "Nasir tried to solve an equation.\n\n$\\begin{align}\n7.7&=w-2\\\\\\\\\n7.7-2&=w-2+2&\\tealE{\\text{Setting up}}\\\\\\\\\n5.7&=w&\\purpleD{\\text{Calculating}}\n\\end{align}$\n\n**Where did Nasir make his first mistake?**\n\n[[☃ radio 2]]",
    "widgets": {
      "radio 2": {
        "type": "radio",
        "graded": true,
        "static": false,
        "options": {
          "choices": [
            {
              "content": "$\\tealE{\\text{Setting up}}$",
              "correct": true
            },
            {
              "content": "$\\purpleD{\\text{Calculating}}$",
              "correct": false
            },
            {
              "content": "Nasir correctly solved the equation.",
              "correct": false,
              "isNoneOfTheAbove": false
            }
          ],
          "randomize": false,
          "countChoices": false,
          "displayCount": null,
          "multipleSelect": false,
          "deselectEnabled": false,
          "hasNoneOfTheAbove": false
        },
        "version": {
          "major": 1,
          "minor": 0
        },
        "alignment": "default"
      }
    }
  },
  "answerArea": {
    "tTable": false,
    "zTable": false,
    "chi2Table": false,
    "calculator": false,
    "periodicTable": false
  },
  "itemDataVersion": {
    "major": 0,
    "minor": 1
  }
}
```

### Structured JSON (generated)
```json
{
  "body": [
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "Nasir tried to solve an equation."
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "math",
          "mathml": "<mrow><mtable><mtr><mtd><mrow><mn>7.7</mn><mo>=</mo><mi>w</mi><mo>-</mo><mn>2</mn></mrow></mtd></mtr><mtr><mtd><mrow><mn>7.7</mn><mo>-</mo><mn>2</mn><mo>=</mo><mi>w</mi><mo>-</mo><mn>2</mn><mo>+</mo><mn>2</mn></mrow></mtd><mtd><mtext>Setting up</mtext></mtd></mtr><mtr><mtd><mrow><mn>5.7</mn><mo>=</mo><mi>w</mi></mrow></mtd><mtd><mtext>Calculating</mtext></mtd></mtr></mtable></mrow>"
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "Where did Nasir make his first mistake?"
        }
      ]
    },
    {
      "type": "blockSlot",
      "slotId": "choice_interaction"
    }
  ],
  "title": "Identify the first mistake in solving an equation",
  "widgets": {},
  "feedback": {
    "correct": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Correct! Nasir's first mistake was in setting up."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "He performed different operations on the two sides of the equation; he should have added 2 to both sides."
          }
        ]
      }
    ],
    "incorrect": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Strategy: To set up the equation for solving, Nasir needs to perform the same operation on both sides of the equation. To calculate the solution, he needs to correctly solve the equation he set up."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "When setting up the equation, Nasir subtracted 2 from the left side and added 2 to the right side. This is a mistake. He should have added 2 to both sides of the equation."
          }
        ]
      }
    ]
  },
  "identifier": "nasir-first-mistake-radio",
  "interactions": {
    "choice_interaction": {
      "type": "choiceInteraction",
      "prompt": [
        {
          "type": "text",
          "content": "Where did Nasir make his first mistake?"
        }
      ],
      "choices": [
        {
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "content": "Setting up"
                }
              ]
            }
          ],
          "feedback": null,
          "identifier": "A"
        },
        {
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "content": "Calculating"
                }
              ]
            }
          ],
          "feedback": null,
          "identifier": "B"
        },
        {
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "text",
                  "content": "Nasir correctly solved the equation."
                }
              ]
            }
          ],
          "feedback": null,
          "identifier": "C"
        }
      ],
      "shuffle": true,
      "maxChoices": 1,
      "minChoices": 1,
      "responseIdentifier": "RESPONSE"
    }
  },
  "responseDeclarations": [
    {
      "correct": "A",
      "baseType": "identifier",
      "identifier": "RESPONSE",
      "cardinality": "single"
    }
  ]
}
```

### Relevant code
- Compiler (prompt/body dedupe) — src/lib/qti-generation/compiler.ts
```
	return Object.keys(typedSchemas).includes(type)
}

function dedupePromptTextFromBody(item: AssessmentItem): void {
	if (!item.interactions || !item.body) return

	const promptTexts = new Set<string>()
	for (const interaction of Object.values(item.interactions)) {
		if (interaction.type === "choiceInteraction" || interaction.type === "orderInteraction") {
			const prompt = interaction.prompt
			if (prompt.length === 1 && prompt[0]?.type === "text") {
				promptTexts.add(prompt[0].content)
			}
		}
	}
	if (promptTexts.size === 0) return

	const originalLength = item.body.length
	item.body = item.body.filter((block) => {
		if (block.type !== "paragraph") return true
		if (block.content.length !== 1) return true
		const only = block.content[0]
		if (only?.type !== "text") return true
		return !promptTexts.has(only.content)
	})
	const removedCount = originalLength - item.body.length
	if (removedCount > 0) {
		logger.debug("deduplicated prompt text from body", { count: removedCount })
	}
}

export function compile(itemData: AssessmentItemInput): string {
	// Step 0: Build widget mapping prior to schema enforcement
	const widgetMapping: Record<string, string> = {}
	if (itemData.widgets) {
		for (const [key, value] of Object.entries(itemData.widgets)) {
			if (value?.type) widgetMapping[key] = value.type
		}
	}

	// FIX: Add strict validation for widget types before creating the schema.
	// Create a properly typed mapping object
	const validatedWidgetMapping: Record<string, keyof typeof typedSchemas> = {}

	for (const [key, type] of Object.entries(widgetMapping)) {
		if (!isValidWidgetType(type)) {
```

- Compiler finalization (missing URL hardening) — src/lib/qti-generation/compiler.ts
```
	finalXml = stripXmlComments(finalXml, logger)
	finalXml = removeDoubleNewlines(finalXml, logger)
	finalXml = fixMathMLOperators(finalXml, logger)
	finalXml = fixInequalityOperators(finalXml, logger)
	// Convert HTML entities to Unicode characters at the very end
	return convertHtmlEntities(finalXml, logger)
}

```

### Root cause analysis
- Prompt/body dedupe is fragile for mixed MathML + text and multi-paragraph prompts.
- Similar strings with MathML tokens evade naive equality checks.

### Proposed fixes
- Improve dedupe with normalized tokenization: strip MathML to plain text for comparison and compare normalized paragraphs.
- Add deterministic rule: prompt text must only live in interaction.prompt; remove identical/similar text from body.
- Unit-test a suite of prompt/body duplication cases.
