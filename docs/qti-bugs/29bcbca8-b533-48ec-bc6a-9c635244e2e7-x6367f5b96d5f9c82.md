# Find x using vertical angles

- **analysisId**: 29bcbca8-b533-48ec-bc6a-9c635244e2e7
- **questionId**: x6367f5b96d5f9c82
- **severity**: major

### Issue
While semantically the diagram matches what is needed to solve the problem, the diagram does not properly match the original. The XML rendered diagram has only two intersecting lines, whereas the original has three intersecting lines where two of the lines are parallel; the XML rendered diagram has all three angles centered on the same point, whereas the original has the "x" and "145°" on the same center point (from one of the intersection points) and "35°" on the other center point (from the other intersection point).

### Perseus (original)
```json
{
  "hints": [
    {
      "images": {},
      "content": "The angles marked below are vertical angles because they are angles opposite each other where two lines cross.\n\n\n[[☃ image 1]]\n\n",
      "replace": false,
      "widgets": {
        "image 1": {
          "type": "image",
          "graded": true,
          "static": false,
          "options": {
            "alt": "Two parallel lines intersected by a transversal at two points. The transversal and the lower parallel line make Two opposite obtuse angles labeled as X degrees and 145 degrees.\n",
            "box": [
              260,
              130
            ],
            "range": [
              [
                0,
                10
              ],
              [
                0,
                10
              ]
            ],
            "title": "",
            "labels": [],
            "static": false,
            "caption": "",
            "backgroundImage": {
              "url": "web+graphie://cdn.kastatic.org/ka-perseus-graphie/2d701c29d00fcfede71aef0c07740a52e10e4ead",
              "width": 260,
              "height": 130
            }
          },
          "version": {
            "major": 0,
            "minor": 0
          },
          "alignment": "block"
        }
      }
    },
    {
      "images": {},
      "content": "Vertical angles are equivalent.",
      "replace": false,
      "widgets": {}
    },
    {
      "images": {},
      "content": "$x = 145^\\circ$",
      "replace": false,
      "widgets": {}
    }
  ],
  "question": {
    "images": {},
    "content": "\n[[☃ image 1]]\n\n$x = $ [[☃ numeric-input 1]]$^\\circ$\n",
    "widgets": {
      "image 1": {
        "type": "image",
        "graded": true,
        "static": false,
        "options": {
          "alt": "Two parallel lines intersected by a transversal at two points. The transversal and the lower parallel line make Two opposite obtuse angles labeled as X degrees and 145 degrees. The adjacent angle to angle x is labeled as 35 degrees.\n",
          "box": [
            260,
            130
          ],
          "range": [
            [
              0,
              10
            ],
            [
              0,
              10
            ]
          ],
          "title": "",
          "labels": [],
          "static": false,
          "caption": "",
          "backgroundImage": {
            "url": "web+graphie://cdn.kastatic.org/ka-perseus-graphie/36deb280c828e99527b8c5b5b5c60fba80e27bbc",
            "width": 260,
            "height": 130
          }
        },
        "version": {
          "major": 0,
          "minor": 0
        },
        "alignment": "block"
      },
      "numeric-input 1": {
        "type": "numeric-input",
        "graded": true,
        "static": false,
        "options": {
          "size": "normal",
          "static": false,
          "answers": [
            {
              "value": 145,
              "status": "correct",
              "strict": false,
              "message": "",
              "maxError": null,
              "simplify": "required"
            }
          ],
          "labelText": "",
          "rightAlign": false,
          "coefficient": false
        },
        "version": {
          "major": 0,
          "minor": 0
        },
        "alignment": "default"
      }
    }
  },
  "answerArea": {
    "tTable": false,
    "zTable": false,
    "chi2Table": false,
    "calculator": false,
    "periodicTable": false,
    "periodicTableWithKey": false,
    "financialCalculatorTotalAmount": false,
    "financialCalculatorTimeToPayOff": false,
    "financialCalculatorMonthlyPayment": false
  },
  "itemDataVersion": {
    "major": 0,
    "minor": 1
  }
}
```

### Structured JSON (generated)
```json
{
  "body": [
    {
      "type": "blockSlot",
      "slotId": "image_1"
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "math",
          "mathml": "<mi>x</mi><mo>=</mo>"
        },
        {
          "type": "text",
          "content": " "
        },
        {
          "type": "inlineSlot",
          "slotId": "x_entry"
        },
        {
          "type": "math",
          "mathml": "<mo>°</mo>"
        }
      ]
    }
  ],
  "title": "Find x using vertical angles",
  "widgets": {
    "image_1": {
      "rays": [
        {
          "to": "HL",
          "from": "V"
        },
        {
          "to": "HR",
          "from": "V"
        },
        {
          "to": "TUL",
          "from": "V"
        },
        {
          "to": "TDR",
          "from": "V"
        }
      ],
      "type": "angleDiagram",
      "width": 260,
      "angles": [
        {
          "color": "#e07d10",
          "label": "x",
          "radius": 22,
          "vertices": [
            "HR",
            "V",
            "TUL"
          ],
          "isRightAngle": false
        },
        {
          "color": "#11accd",
          "label": "35°",
          "radius": 16,
          "vertices": [
            "HR",
            "V",
            "TDR"
          ],
          "isRightAngle": false
        },
        {
          "color": "#1fab54",
          "label": "145°",
          "radius": 22,
          "vertices": [
            "HL",
            "V",
            "TDR"
          ],
          "isRightAngle": false
        }
      ],
      "height": 130,
      "points": [
        {
          "x": 150,
          "y": 71,
          "id": "V",
          "label": "",
          "shape": "circle"
        },
        {
          "x": 90,
          "y": 71,
          "id": "HL",
          "label": "",
          "shape": "circle"
        },
        {
          "x": 210,
          "y": 71,
          "id": "HR",
          "label": "",
          "shape": "circle"
        },
        {
          "x": 100.9,
          "y": 36.6,
          "id": "TUL",
          "label": "",
          "shape": "circle"
        },
        {
          "x": 199.1,
          "y": 105.4,
          "id": "TDR",
          "label": "",
          "shape": "circle"
        }
      ]
    }
  },
  "feedback": {
    "correct": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Correct! "
          },
          {
            "type": "math",
            "mathml": "<mi>x</mi><mo>=</mo><mn>145</mn><mo>°</mo>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ],
    "incorrect": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "The angles marked are vertical angles because they are opposite each other where two lines cross."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Vertical angles are equivalent."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "So "
          },
          {
            "type": "math",
            "mathml": "<mi>x</mi><mo>=</mo><mn>145</mn><mo>°</mo>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ]
  },
  "identifier": "vertical-angles-equality",
  "interactions": {
    "x_entry": {
      "type": "textEntryInteraction",
      "expectedLength": 3,
      "responseIdentifier": "RESPONSE"
    }
  },
  "responseDeclarations": [
    {
      "correct": 145,
      "baseType": "integer",
      "identifier": "RESPONSE",
      "cardinality": "single"
    }
  ]
}
```

### Relevant code
- Widget registry — src/lib/widgets/generators/index.ts
```
import { generateVennDiagram, VennDiagramPropsSchema } from "./venn-diagram"
import { generateVerticalArithmeticSetup, VerticalArithmeticSetupPropsSchema } from "./vertical-arithmetic-setup"

// The `type` field is now included in the base schemas, so we remove .extend()
export const typedSchemas = {
	"3dIntersectionDiagram": ThreeDIntersectionDiagramPropsSchema,
	absoluteValueNumberLine: AbsoluteValueNumberLinePropsSchema,
	angleDiagram: AngleDiagramPropsSchema,
	barChart: BarChartPropsSchema,
	boxGrid: BoxGridPropsSchema,
	boxPlot: BoxPlotPropsSchema,
	circleDiagram: CircleDiagramPropsSchema,
	compositeShapeDiagram: CompositeShapeDiagramPropsSchema,
	coordinatePlane: CoordinatePlaneComprehensivePropsSchema,
	distanceFormulaGraph: DistanceFormulaGraphPropsSchema,
	functionPlotGraph: FunctionPlotGraphPropsSchema,
	lineEquationGraph: LineEquationGraphPropsSchema,
	pointPlotGraph: PointPlotGraphPropsSchema,
	polygonGraph: PolygonGraphPropsSchema,
	shapeTransformationGraph: ShapeTransformationGraphPropsSchema,
	dataTable: DataTablePropsSchema,
	discreteObjectRatioDiagram: DiscreteObjectRatioDiagramPropsSchema,
	dotPlot: DotPlotPropsSchema,
	doubleNumberLine: DoubleNumberLinePropsSchema,
	emojiImage: EmojiImagePropsSchema,
	figureComparisonDiagram: FigureComparisonDiagramPropsSchema,
	fractionNumberLine: FractionNumberLinePropsSchema,
	geometricSolidDiagram: GeometricSolidDiagramPropsSchema,
	hangerDiagram: HangerDiagramPropsSchema,
	histogram: HistogramPropsSchema,
	inequalityNumberLine: InequalityNumberLinePropsSchema,
	numberLine: NumberLinePropsSchema,
	numberLineForOpposites: NumberLineForOppositesPropsSchema,
	numberLineWithAction: NumberLineWithActionPropsSchema,
	numberLineWithFractionGroups: NumberLineWithFractionGroupsPropsSchema,
	numberSetDiagram: NumberSetDiagramPropsSchema,
	partitionedShape: PartitionedShapePropsSchema,
	pentagonIntersectionDiagram: PentagonIntersectionDiagramPropsSchema,
	pictograph: PictographPropsSchema,
	polyhedronDiagram: PolyhedronDiagramPropsSchema,
	probabilitySpinner: ProbabilitySpinnerPropsSchema,
	polyhedronNetDiagram: PolyhedronNetDiagramPropsSchema,
	pythagoreanProofDiagram: PythagoreanProofDiagramPropsSchema,
	ratioBoxDiagram: RatioBoxDiagramPropsSchema,
	rectangularFrameDiagram: RectangularFrameDiagramPropsSchema,
	scaleCopiesSlider: ScaleCopiesSliderPropsSchema,
```

- Compiler finalization (missing URL hardening) — src/lib/qti-generation/compiler.ts
```
	finalXml = stripXmlComments(finalXml, logger)
	finalXml = removeDoubleNewlines(finalXml, logger)
	finalXml = fixMathMLOperators(finalXml, logger)
	finalXml = fixInequalityOperators(finalXml, logger)
	// Convert HTML entities to Unicode characters at the very end
	return convertHtmlEntities(finalXml, logger)
}

```

### Root cause analysis
- Widget generators lack fine-grained layout controls for label spacing, tick sizing, and overlays (e.g., best-fit lines).
- Some required annotations (e.g., heights, arcs) aren’t dynamically computed or placed to avoid overlaps.

### Proposed fixes
- Add layout parameters (label offsets, min separation, collision avoidance) and derive sensible defaults per widget.
- Implement overlay support (e.g., regression line) where pedagogy demands it.
- Introduce visual QA validators to detect unreadable overlaps or missing required annotations.
