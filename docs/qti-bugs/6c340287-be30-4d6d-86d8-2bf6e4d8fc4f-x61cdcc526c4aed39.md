# Probability of rolling less than 4 on a fair die

- **analysisId**: 6c340287-be30-4d6d-86d8-2bf6e4d8fc4f
- **questionId**: x61cdcc526c4aed39
- **severity**: major

### Issue
The correct answer (i.e., "0.5") is marked as incorrect upon submission. There should be a space between the "than" and "4" in mathml text of "P(roll less than4)". The input should be one a new line.

### Perseus (original)
```json
{
  "hints": [
    {
      "images": {},
      "content": "$\\text{Probability} = \\dfrac{\\text{Number of favorable outcomes}}{\\text{Number of possible outcomes}}$",
      "widgets": {}
    },
    {
      "images": {},
      "content": "There are $3$ favorable outcomes $($rolling a $1$, $2$, or $3)$.\n\nThere are $6$ possible outcomes since it is a $6$-sided die.",
      "widgets": {}
    },
    {
      "images": {},
      "content": "$\\qquad \\text{P(roll less than 4}) = \\dfrac{3}{6} = 0.5$",
      "widgets": {}
    }
  ],
  "question": {
    "images": {},
    "content": "You roll a fair $6$-sided die.\n\n**What is $\\text{P(roll less than 4})$?**  \n*If necessary, round your answer to $2$ decimal places.*  \n[[☃ input-number 1]]\n\n",
    "widgets": {
      "input-number 1": {
        "type": "input-number",
        "graded": true,
        "options": {
          "size": "normal",
          "value": 0.5,
          "inexact": true,
          "maxError": 0.005,
          "simplify": "optional",
          "answerType": "percent"
        },
        "version": {
          "major": 0,
          "minor": 0
        }
      },
      "numeric-input 1": {
        "type": "numeric-input",
        "graded": true,
        "options": {
          "size": "normal",
          "answers": [
            {
              "value": 0.5,
              "status": "correct",
              "strict": true,
              "message": "",
              "maxError": null,
              "simplify": "required",
              "answerForms": [
                "decimal"
              ]
            },
            {
              "value": 0.5,
              "status": "wrong",
              "strict": false,
              "message": "Make sure to express your answer as a simplified fraction!",
              "maxError": 0.01,
              "simplify": "required"
            }
          ],
          "coefficient": false
        },
        "version": {
          "major": 0,
          "minor": 0
        }
      }
    }
  },
  "answerArea": {
    "type": "multiple",
    "options": {
      "images": {},
      "content": "",
      "widgets": {}
    },
    "calculator": true
  },
  "itemDataVersion": {
    "major": 0,
    "minor": 1
  }
}
```

### Structured JSON (generated)
```json
{
  "body": [
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "You roll a fair "
        },
        {
          "type": "math",
          "mathml": "<mn>6</mn>"
        },
        {
          "type": "text",
          "content": "-sided die."
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "What is "
        },
        {
          "type": "math",
          "mathml": "<mi>P</mi><mo>(</mo><mtext>roll less than </mtext><mn>4</mn><mo>)</mo>"
        },
        {
          "type": "text",
          "content": "? If necessary, round your answer to "
        },
        {
          "type": "math",
          "mathml": "<mn>2</mn>"
        },
        {
          "type": "text",
          "content": " decimal places. "
        },
        {
          "type": "inlineSlot",
          "slotId": "input_number_1"
        }
      ]
    }
  ],
  "title": "Probability of rolling less than 4 on a fair die",
  "widgets": {},
  "feedback": {
    "correct": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Correct! The probability is "
          },
          {
            "type": "math",
            "mathml": "<mfrac><mn>1</mn><mn>2</mn></mfrac>"
          },
          {
            "type": "text",
            "content": " ("
          },
          {
            "type": "math",
            "mathml": "<mn>0.5</mn>"
          },
          {
            "type": "text",
            "content": ")."
          }
        ]
      }
    ],
    "incorrect": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<mtext>Probability</mtext><mo>=</mo><mfrac><mtext>Number of favorable outcomes</mtext><mtext>Number of possible outcomes</mtext></mfrac>"
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "There are "
          },
          {
            "type": "math",
            "mathml": "<mn>3</mn>"
          },
          {
            "type": "text",
            "content": " favorable outcomes (rolling a "
          },
          {
            "type": "math",
            "mathml": "<mn>1</mn>"
          },
          {
            "type": "text",
            "content": ", "
          },
          {
            "type": "math",
            "mathml": "<mn>2</mn>"
          },
          {
            "type": "text",
            "content": ", or "
          },
          {
            "type": "math",
            "mathml": "<mn>3</mn>"
          },
          {
            "type": "text",
            "content": "). There are "
          },
          {
            "type": "math",
            "mathml": "<mn>6</mn>"
          },
          {
            "type": "text",
            "content": " possible outcomes since it is a "
          },
          {
            "type": "math",
            "mathml": "<mn>6</mn>"
          },
          {
            "type": "text",
            "content": "-sided die."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<mi>P</mi><mo>(</mo><mtext>roll less than </mtext><mn>4</mn><mo>)</mo><mo>=</mo><mfrac><mn>3</mn><mn>6</mn></mfrac><mo>=</mo><mn>0.5</mn>"
          }
        ]
      }
    ]
  },
  "identifier": "probability-roll-less-than-4",
  "interactions": {
    "input_number_1": {
      "type": "textEntryInteraction",
      "expectedLength": null,
      "responseIdentifier": "RESPONSE"
    }
  },
  "responseDeclarations": [
    {
      "correct": "1/2",
      "baseType": "string",
      "identifier": "RESPONSE",
      "cardinality": "single"
    }
  ]
}
```

### Relevant code
- Renderer (paragraph vs block slot) — src/lib/qti-generation/content-renderer.ts
```
		.join("")
}

export function renderBlockContent(blockItems: BlockContent | null | undefined, slots: Map<string, string>): string {
	if (!blockItems) return ""
	return blockItems
		.map((item) => {
			switch (item.type) {
				case "paragraph":
					return `<p>${renderInlineContent(item.content, slots)}</p>`
				case "blockSlot": {
					const content = slots.get(item.slotId)
					if (content === undefined) {
						throw errors.new(`Compiler Error: Content for block slot '${item.slotId}' not found.`)
					}
					return `<div>${content}</div>` // ALWAYS wrap block slots in a div
				}
			}
		})
		.join("\n        ")
}

```

- Response normalization — src/lib/qti-generation/response-processor.ts
```
import { isTerminatingFraction } from "./helpers"
import type { AssessmentItem } from "./schemas"

export function compileResponseDeclarations(decls: AssessmentItem["responseDeclarations"]): string {
	// Guardrail: ensure identifier-base declarations use choice identifiers, not labels
	for (const decl of decls) {
		if (decl.baseType === "identifier") {
			const correctValues = Array.isArray(decl.correct) ? decl.correct : [decl.correct]
			const offending = correctValues.filter((v): v is string => typeof v === "string" && /\s/.test(v))
			if (offending.length > 0) {
				logger.error("identifier response contains non-identifier values", {
					responseIdentifier: decl.identifier,
					offending
				})
				throw errors.new(
					`response '${decl.identifier}' expects choice identifier(s); found label-like value(s): [${offending.join(", ")}]`
				)
			}
		}
	}

	// Pre-process declarations to add equivalent numeric mappings.
	return decls
		.map((decl) => {
			const correctValues = Array.isArray(decl.correct) ? decl.correct : [decl.correct]
			const allCorrectValues = new Set<string | number>(correctValues)

			for (const val of correctValues) {
				if (typeof val !== "string") continue

				if (val.startsWith(".")) allCorrectValues.add(`0${val}`)
				else if (val.startsWith("0.")) allCorrectValues.add(val.substring(1))

				// Rule: Allow implicit multiplication between a leading numeric coefficient and parentheses
				// e.g., 25*(p+2q) -> also accept 25(p+2q)
				{
					const implicitAlt = val.replace(/(\d+)\s*\*\s*\(/g, "$1(")
					if (implicitAlt !== val) {
						allCorrectValues.add(implicitAlt)
					}
				}

				if (val.includes("/") && !val.startsWith(".")) {
					const parts = val.split("/")
					if (parts.length === 2 && parts[0] && parts[1]) {
						const num = Number.parseInt(parts[0], 10)
```

- Compiler finalization (missing URL hardening) — src/lib/qti-generation/compiler.ts
```
	finalXml = stripXmlComments(finalXml, logger)
	finalXml = removeDoubleNewlines(finalXml, logger)
	finalXml = fixMathMLOperators(finalXml, logger)
	finalXml = fixInequalityOperators(finalXml, logger)
	// Convert HTML entities to Unicode characters at the very end
	return convertHtmlEntities(finalXml, logger)
}

```

### Root cause analysis
- Shell generation places textEntry as inlineSlot within paragraphs by default.
- Renderer wraps paragraph content in <p>, so the input remains inline with preceding text.
- Response normalization covers terminating fraction ↔ decimal, inequality ASCII/Unicode, and equation reversal, but lacks π approximation tolerance and whitespace-insensitive algebraic matching.
- Some items expect reversible equations or spacing variants beyond current patterns.

### Proposed fixes
- Prompt rule: when a textEntry follows terminal punctuation or when the issue requests separation, generate a blockSlot instead.
- Compiler pass: promote trailing inline textEntry to a <div> wrapped block rendering.
- Add layout hinting in structured schema (e.g., expectedLineBreak) that compiler respects.
- Add π ↔ decimal alternatives when instructions permit approximations (configurable precision).
- Normalize algebraic strings by removing superfluous whitespace and common formatting differences before comparison.
- Extend inequality/equation normalization to cover more operator/spacing permutations.
- Consider numeric parsing with tolerance for numeric-only textEntry items.
