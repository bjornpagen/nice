# Apply the distributive property to factor out the greatest common factor

- **analysisId**: 2df34d46-ca0d-4806-80a3-4a4bffd7c18b
- **questionId**: x6171f434c2d47023
- **severity**: patch

### Issue
Whitespace on the interior of the answer (e.g., "9(5e - 3f)" instead of "9(5e-3f)") causes the answer to be marked as incorrect.

### Perseus (original)
```json
{
  "hints": [
    {
      "images": {},
      "content": "Let's find the greatest common factor of $\\blue{45}$ and $\\pink{27}$.",
      "widgets": {}
    },
    {
      "images": {},
      "content": "$\\green{9}$ is the greatest common factor of $\\blue{45}$ and $\\pink{27}$. ",
      "widgets": {}
    },
    {
      "images": {},
      "content": "$\\phantom{=}\\blue{45}e - \\pink{27}f$\n\n$=\\green{9}\\left(\\dfrac{\\blue{45}e}{\\green{9}}-\\dfrac{\\pink{27}f}{\\green{9}}\\right)$\n",
      "widgets": {}
    },
    {
      "images": {},
      "content": "$=\\green{9}(5e-3f)$",
      "widgets": {}
    }
  ],
  "question": {
    "images": {},
    "content": "**Apply the distributive property to factor out the greatest common factor.**\n\n${45e -27f} =$ [[☃ expression 1]]",
    "widgets": {
      "expression 1": {
        "type": "expression",
        "graded": true,
        "options": {
          "times": false,
          "functions": [],
          "buttonSets": [
            "basic"
          ],
          "answerForms": [
            {
              "key": 0,
              "form": true,
              "value": "9\\left(5e-3f\\right)",
              "simplify": false,
              "considered": "correct"
            }
          ]
        },
        "version": {
          "major": 1,
          "minor": 0
        }
      }
    }
  },
  "answerArea": {
    "type": "multiple",
    "options": {
      "images": {},
      "content": "",
      "widgets": {}
    },
    "calculator": false
  },
  "itemDataVersion": {
    "major": 0,
    "minor": 1
  }
}
```

### Structured JSON (generated)
```json
{
  "body": [
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "Apply the distributive property to factor out the greatest common factor."
        }
      ]
    },
    {
      "type": "paragraph",
      "content": [
        {
          "type": "math",
          "mathml": "<mn>45</mn><mi>e</mi><mo>-</mo><mn>27</mn><mi>f</mi><mo>=</mo>"
        },
        {
          "type": "text",
          "content": " "
        },
        {
          "type": "inlineSlot",
          "slotId": "expression_entry"
        }
      ]
    }
  ],
  "title": "Apply the distributive property to factor out the greatest common factor",
  "widgets": {},
  "feedback": {
    "correct": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Correct! "
          },
          {
            "type": "math",
            "mathml": "<mn>45</mn><mi>e</mi><mo>-</mo><mn>27</mn><mi>f</mi><mo>=</mo><mn>9</mn><mrow><mo>(</mo><mrow><mn>5</mn><mi>e</mi><mo>-</mo><mn>3</mn><mi>f</mi></mrow><mo>)</mo></mrow>"
          }
        ]
      }
    ],
    "incorrect": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Let's find the greatest common factor of "
          },
          {
            "type": "math",
            "mathml": "<mn>45</mn>"
          },
          {
            "type": "text",
            "content": " and "
          },
          {
            "type": "math",
            "mathml": "<mn>27</mn>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<mn>9</mn>"
          },
          {
            "type": "text",
            "content": " is the greatest common factor of "
          },
          {
            "type": "math",
            "mathml": "<mn>45</mn>"
          },
          {
            "type": "text",
            "content": " and "
          },
          {
            "type": "math",
            "mathml": "<mn>27</mn>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Start by writing the expression and factoring out the GCF: "
          },
          {
            "type": "math",
            "mathml": "<mn>45</mn><mi>e</mi><mo>-</mo><mn>27</mn><mi>f</mi>"
          },
          {
            "type": "text",
            "content": " "
          },
          {
            "type": "math",
            "mathml": "<mo>=</mo><mn>9</mn><mrow><mo>(</mo><mrow><mfrac><mrow><mn>45</mn><mi>e</mi></mrow><mn>9</mn></mfrac><mo>-</mo><mfrac><mrow><mn>27</mn><mi>f</mi></mrow><mn>9</mn></mfrac></mrow><mo>)</mo></mrow>"
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "math",
            "mathml": "<mo>=</mo><mn>9</mn><mrow><mo>(</mo><mrow><mn>5</mn><mi>e</mi><mo>-</mo><mn>3</mn><mi>f</mi></mrow><mo>)</mo></mrow>"
          }
        ]
      }
    ]
  },
  "identifier": "factor-gcf-distributive-expression",
  "interactions": {
    "expression_entry": {
      "type": "textEntryInteraction",
      "expectedLength": 8,
      "responseIdentifier": "RESPONSE"
    }
  },
  "responseDeclarations": [
    {
      "correct": "9(5e-3f)",
      "baseType": "string",
      "identifier": "RESPONSE",
      "cardinality": "single"
    }
  ]
}
```

### Relevant code
- Response normalization — src/lib/qti-generation/response-processor.ts
```
import { isTerminatingFraction } from "./helpers"
import type { AssessmentItem } from "./schemas"

export function compileResponseDeclarations(decls: AssessmentItem["responseDeclarations"]): string {
	// Guardrail: ensure identifier-base declarations use choice identifiers, not labels
	for (const decl of decls) {
		if (decl.baseType === "identifier") {
			const correctValues = Array.isArray(decl.correct) ? decl.correct : [decl.correct]
			const offending = correctValues.filter((v): v is string => typeof v === "string" && /\s/.test(v))
			if (offending.length > 0) {
				logger.error("identifier response contains non-identifier values", {
					responseIdentifier: decl.identifier,
					offending
				})
				throw errors.new(
					`response '${decl.identifier}' expects choice identifier(s); found label-like value(s): [${offending.join(", ")}]`
				)
			}
		}
	}

	// Pre-process declarations to add equivalent numeric mappings.
	return decls
		.map((decl) => {
			const correctValues = Array.isArray(decl.correct) ? decl.correct : [decl.correct]
			const allCorrectValues = new Set<string | number>(correctValues)

			for (const val of correctValues) {
				if (typeof val !== "string") continue

				if (val.startsWith(".")) allCorrectValues.add(`0${val}`)
				else if (val.startsWith("0.")) allCorrectValues.add(val.substring(1))

				// Rule: Allow implicit multiplication between a leading numeric coefficient and parentheses
				// e.g., 25*(p+2q) -> also accept 25(p+2q)
				{
					const implicitAlt = val.replace(/(\d+)\s*\*\s*\(/g, "$1(")
					if (implicitAlt !== val) {
						allCorrectValues.add(implicitAlt)
					}
				}

				if (val.includes("/") && !val.startsWith(".")) {
					const parts = val.split("/")
					if (parts.length === 2 && parts[0] && parts[1]) {
						const num = Number.parseInt(parts[0], 10)
```

- Compiler finalization (missing URL hardening) — src/lib/qti-generation/compiler.ts
```
	finalXml = stripXmlComments(finalXml, logger)
	finalXml = removeDoubleNewlines(finalXml, logger)
	finalXml = fixMathMLOperators(finalXml, logger)
	finalXml = fixInequalityOperators(finalXml, logger)
	// Convert HTML entities to Unicode characters at the very end
	return convertHtmlEntities(finalXml, logger)
}

```
