# Name the marked angle

- **analysisId**: 817c0930-a745-494f-92fe-52fc6c9ba484
- **questionId**: x625ad667229f1a4c
- **severity**: major

### Issue
The diagram gives away the answer (i.e., "EAF") by labeling the angle arc. The point labels "A" and "B" are being overlapped by nearby lines.

### Perseus (original)
```json
{
  "hints": [
    {
      "images": {},
      "content": "We can name the angle using $3$ points, one on each side of the angle and one at the vertex.  \n\n[[☃ image 1]]\n\nThe vertex point *must* be the middle letter.  The other letters can be in either order: ${\\angle E\\blueD{A}F}$ or ${\\angle \nF\\blueD{A}E}$.",
      "replace": false,
      "widgets": {
        "image 1": {
          "type": "image",
          "graded": true,
          "static": false,
          "options": {
            "alt": "Five rays. One ray starts at point A, then points down and to the left through point B. A second ray starts at point A, then points up and to the left through point E. A third ray starts at point A, then points up through point F. A fourth ray starts at point A, then points up and to the right through point D. A fifth ray starts at point A, then points down and to the right through point C. A blue curved line connects ray AE to ray AF. Ray AE and ray AF, and points A, E, and F are blue.",
            "box": [
              300,
              225
            ],
            "range": [
              [
                0,
                10
              ],
              [
                0,
                10
              ]
            ],
            "title": "",
            "labels": [],
            "static": false,
            "caption": "",
            "backgroundImage": {
              "url": "web+graphie://cdn.kastatic.org/ka-perseus-graphie/232de0139c70321a08fc73e49a7b0b9e5eac45ca",
              "width": 300,
              "height": 225
            }
          },
          "version": {
            "major": 0,
            "minor": 0
          },
          "alignment": "block"
        }
      }
    },
    {
      "images": {},
      "content": "A name for the angle is $\\angle{EAF}$.",
      "replace": false,
      "widgets": {}
    }
  ],
  "question": {
    "images": {},
    "content": "**What is a name for the marked angle?**\n\n[[☃ image 1]]\n\n[[☃ radio 1]]",
    "widgets": {
      "image 1": {
        "type": "image",
        "graded": true,
        "static": false,
        "options": {
          "alt": "Five rays. One ray starts at point A, then points down and to the left through point B. A second ray starts at point A, then points up and to the left through point E. A third ray starts at point A, then points up through point F. A fourth ray starts at point A, then points up and to the right through point D. A fifth ray starts at point A, then points down and to the right through point C.  A blue curved line connects ray AE to ray AF.",
          "box": [
            300,
            225
          ],
          "range": [
            [
              0,
              10
            ],
            [
              0,
              10
            ]
          ],
          "title": "",
          "labels": [],
          "static": false,
          "caption": "",
          "backgroundImage": {
            "url": "web+graphie://cdn.kastatic.org/ka-perseus-graphie/7cea7562383a480cd2dd452ce1b128b701f14c54",
            "width": 300,
            "height": 225
          }
        },
        "version": {
          "major": 0,
          "minor": 0
        },
        "alignment": "block"
      },
      "radio 1": {
        "type": "radio",
        "graded": true,
        "static": false,
        "options": {
          "choices": [
            {
              "content": "$\\angle{EAB}$",
              "correct": false
            },
            {
              "content": "$\\angle{CAD}$",
              "correct": false
            },
            {
              "content": "$\\angle{EAF}$",
              "correct": true,
              "isNoneOfTheAbove": false
            },
            {
              "content": "$\\angle{AFE}$",
              "correct": false,
              "isNoneOfTheAbove": false
            }
          ],
          "randomize": false,
          "countChoices": false,
          "displayCount": null,
          "multipleSelect": false,
          "deselectEnabled": false,
          "hasNoneOfTheAbove": false
        },
        "version": {
          "major": 1,
          "minor": 0
        },
        "alignment": "default"
      }
    }
  },
  "answerArea": {
    "tTable": false,
    "zTable": false,
    "chi2Table": false,
    "calculator": false,
    "periodicTable": false
  },
  "itemDataVersion": {
    "major": 0,
    "minor": 1
  }
}
```

### Structured JSON (generated)
```json
{
  "body": [
    {
      "type": "paragraph",
      "content": [
        {
          "type": "text",
          "content": "What is a name for the marked angle?"
        }
      ]
    },
    {
      "type": "blockSlot",
      "slotId": "angle_diagram"
    },
    {
      "type": "blockSlot",
      "slotId": "choice_interaction"
    }
  ],
  "title": "Name the marked angle",
  "widgets": {
    "angle_diagram": {
      "rays": [
        {
          "to": "B",
          "from": "A"
        },
        {
          "to": "C",
          "from": "A"
        },
        {
          "to": "D",
          "from": "A"
        },
        {
          "to": "E",
          "from": "A"
        },
        {
          "to": "F",
          "from": "A"
        }
      ],
      "type": "angleDiagram",
      "width": 300,
      "angles": [
        {
          "color": "#11accd",
          "label": "EAF",
          "radius": 50,
          "vertices": [
            "E",
            "A",
            "F"
          ],
          "isRightAngle": false
        }
      ],
      "height": 225,
      "points": [
        {
          "x": 150,
          "y": 112.5,
          "id": "A",
          "label": "A",
          "shape": "ellipse"
        },
        {
          "x": 81.484,
          "y": 143.005,
          "id": "B",
          "label": "B",
          "shape": "ellipse"
        },
        {
          "x": 194.084,
          "y": 173.176,
          "id": "C",
          "label": "C",
          "shape": "ellipse"
        },
        {
          "x": 209.101,
          "y": 66.325,
          "id": "D",
          "label": "D",
          "shape": "ellipse"
        },
        {
          "x": 78.671,
          "y": 89.324,
          "id": "E",
          "label": "E",
          "shape": "ellipse"
        },
        {
          "x": 150,
          "y": 37.5,
          "id": "F",
          "label": "F",
          "shape": "ellipse"
        }
      ]
    }
  },
  "feedback": {
    "correct": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Correct! A name for the marked angle is "
          },
          {
            "type": "math",
            "mathml": "<mo>∠</mo><mrow><mi>E</mi><mi>A</mi><mi>F</mi></mrow>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ],
    "incorrect": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Not quite. We name an angle using "
          },
          {
            "type": "math",
            "mathml": "<mn>3</mn>"
          },
          {
            "type": "text",
            "content": " points: one on each side of the angle and one at the vertex. The vertex must be the middle letter."
          }
        ]
      },
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "content": "Here, the vertex is A, so valid names are "
          },
          {
            "type": "math",
            "mathml": "<mo>∠</mo><mrow><mi>E</mi><mi>A</mi><mi>F</mi></mrow>"
          },
          {
            "type": "text",
            "content": " or "
          },
          {
            "type": "math",
            "mathml": "<mo>∠</mo><mrow><mi>F</mi><mi>A</mi><mi>E</mi></mrow>"
          },
          {
            "type": "text",
            "content": "."
          }
        ]
      }
    ]
  },
  "identifier": "name-marked-angle-eaf",
  "interactions": {
    "choice_interaction": {
      "type": "choiceInteraction",
      "prompt": [
        {
          "type": "text",
          "content": "What is a name for the marked angle?"
        }
      ],
      "choices": [
        {
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "math",
                  "mathml": "<mo>∠</mo><mrow><mi>E</mi><mi>A</mi><mi>B</mi></mrow>"
                }
              ]
            }
          ],
          "feedback": null,
          "identifier": "A"
        },
        {
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "math",
                  "mathml": "<mo>∠</mo><mrow><mi>C</mi><mi>A</mi><mi>D</mi></mrow>"
                }
              ]
            }
          ],
          "feedback": null,
          "identifier": "B"
        },
        {
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "math",
                  "mathml": "<mo>∠</mo><mrow><mi>E</mi><mi>A</mi><mi>F</mi></mrow>"
                }
              ]
            }
          ],
          "feedback": null,
          "identifier": "C"
        },
        {
          "content": [
            {
              "type": "paragraph",
              "content": [
                {
                  "type": "math",
                  "mathml": "<mo>∠</mo><mrow><mi>A</mi><mi>F</mi><mi>E</mi></mrow>"
                }
              ]
            }
          ],
          "feedback": null,
          "identifier": "D"
        }
      ],
      "shuffle": true,
      "maxChoices": 1,
      "minChoices": 1,
      "responseIdentifier": "RESPONSE"
    }
  },
  "responseDeclarations": [
    {
      "correct": "C",
      "baseType": "identifier",
      "identifier": "RESPONSE",
      "cardinality": "single"
    }
  ]
}
```

### Relevant code
- Widget registry — src/lib/widgets/generators/index.ts
```
import { generateVennDiagram, VennDiagramPropsSchema } from "./venn-diagram"
import { generateVerticalArithmeticSetup, VerticalArithmeticSetupPropsSchema } from "./vertical-arithmetic-setup"

// The `type` field is now included in the base schemas, so we remove .extend()
export const typedSchemas = {
	"3dIntersectionDiagram": ThreeDIntersectionDiagramPropsSchema,
	absoluteValueNumberLine: AbsoluteValueNumberLinePropsSchema,
	angleDiagram: AngleDiagramPropsSchema,
	barChart: BarChartPropsSchema,
	boxGrid: BoxGridPropsSchema,
	boxPlot: BoxPlotPropsSchema,
	circleDiagram: CircleDiagramPropsSchema,
	compositeShapeDiagram: CompositeShapeDiagramPropsSchema,
	coordinatePlane: CoordinatePlaneComprehensivePropsSchema,
	distanceFormulaGraph: DistanceFormulaGraphPropsSchema,
	functionPlotGraph: FunctionPlotGraphPropsSchema,
	lineEquationGraph: LineEquationGraphPropsSchema,
	pointPlotGraph: PointPlotGraphPropsSchema,
	polygonGraph: PolygonGraphPropsSchema,
	shapeTransformationGraph: ShapeTransformationGraphPropsSchema,
	dataTable: DataTablePropsSchema,
	discreteObjectRatioDiagram: DiscreteObjectRatioDiagramPropsSchema,
	dotPlot: DotPlotPropsSchema,
	doubleNumberLine: DoubleNumberLinePropsSchema,
	emojiImage: EmojiImagePropsSchema,
	figureComparisonDiagram: FigureComparisonDiagramPropsSchema,
	fractionNumberLine: FractionNumberLinePropsSchema,
	geometricSolidDiagram: GeometricSolidDiagramPropsSchema,
	hangerDiagram: HangerDiagramPropsSchema,
	histogram: HistogramPropsSchema,
	inequalityNumberLine: InequalityNumberLinePropsSchema,
	numberLine: NumberLinePropsSchema,
	numberLineForOpposites: NumberLineForOppositesPropsSchema,
	numberLineWithAction: NumberLineWithActionPropsSchema,
	numberLineWithFractionGroups: NumberLineWithFractionGroupsPropsSchema,
	numberSetDiagram: NumberSetDiagramPropsSchema,
	partitionedShape: PartitionedShapePropsSchema,
	pentagonIntersectionDiagram: PentagonIntersectionDiagramPropsSchema,
	pictograph: PictographPropsSchema,
	polyhedronDiagram: PolyhedronDiagramPropsSchema,
	probabilitySpinner: ProbabilitySpinnerPropsSchema,
	polyhedronNetDiagram: PolyhedronNetDiagramPropsSchema,
	pythagoreanProofDiagram: PythagoreanProofDiagramPropsSchema,
	ratioBoxDiagram: RatioBoxDiagramPropsSchema,
	rectangularFrameDiagram: RectangularFrameDiagramPropsSchema,
	scaleCopiesSlider: ScaleCopiesSliderPropsSchema,
```

- Compiler finalization (missing URL hardening) — src/lib/qti-generation/compiler.ts
```
	finalXml = stripXmlComments(finalXml, logger)
	finalXml = removeDoubleNewlines(finalXml, logger)
	finalXml = fixMathMLOperators(finalXml, logger)
	finalXml = fixInequalityOperators(finalXml, logger)
	// Convert HTML entities to Unicode characters at the very end
	return convertHtmlEntities(finalXml, logger)
}

```

### Root cause analysis
- Widget generators lack fine-grained layout controls for label spacing, tick sizing, and overlays (e.g., best-fit lines).
- Some required annotations (e.g., heights, arcs) aren’t dynamically computed or placed to avoid overlaps.

### Proposed fixes
- Add layout parameters (label offsets, min separation, collision avoidance) and derive sensible defaults per widget.
- Implement overlay support (e.g., regression line) where pedagogy demands it.
- Introduce visual QA validators to detect unreadable overlaps or missing required annotations.
