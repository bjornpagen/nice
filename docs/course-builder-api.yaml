openapi: 3.0.3
info:
  title: Nice Course Builder API
  version: 2.0.0
  description: |
    Asynchronous API to build a OneRoster course from CASE standards using AI, link QTI assets,
    create a class, and enroll a student.

    Auth: header API key `x-api-key`.

    Flow:
    - POST `/api/v1/course-builder` enqueues a background job and returns `202 Accepted` with a `jobId`.
    - Poll GET `/api/v1/course-builder/jobs/{jobId}` until `status` is `completed` (returns `courseSourcedId`, `classSourcedId`),
      or `failed` (returns error).

servers:
  - url: /

tags:
  - name: Course Builder

paths:
  /api/v1/course-builder:
    post:
      operationId: enqueueCourseBuilderJob
      tags: [Course Builder]
      summary: Enqueue a course build from CASE learning objective IDs
      description: |
        Validates request and enqueues the course-build workflow. The response contains a `jobId`
        which can be polled to determine job status and retrieve results when completed.
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CourseBuilderRequest'
            examples:
              example:
                value:
                  case_ids:
                    - "cf0f4e1c-aaaa-bbbb-cccc-1234567890ab"
                    - "cf0f4e1c-dddd-eeee-ffff-0987654321cd"
                  student_user_id: "a1b2c3d4-e5f6-11ee-be56-0242ac120002"
                  subject: "Science"
      responses:
        '202':
          description: Job accepted for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseBuilderEnqueueResponse'
              examples:
                example:
                  value:
                    status: queued
                    jobId: "01HXYZABCD1234EFG5678"
                    inputSummary:
                      studentUserId: "a1b2c3d4-e5f6-11ee-be56-0242ac120002"
                      subject: "Science"
                      caseCount: 20
        '400':
          description: Bad request (invalid JSON or validation errors)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseBuilderErrorResponse'
              examples:
                invalid_json:
                  value: { status: error, message: "invalid json" }
                invalid_request:
                  value: { status: error, message: "invalid request" }
        '401':
          description: Unauthorized (missing or invalid API key)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseBuilderErrorResponse'
              examples:
                unauthorized:
                  value: { status: error, message: "Unauthorized" }
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseBuilderErrorResponse'

  /api/v1/course-builder/jobs/{jobId}:
    get:
      operationId: getCourseBuilderJobStatus
      tags: [Course Builder]
      summary: Get job status for a course-build request
      description: |
        Poll this endpoint to retrieve current job status. When `status` is `completed`, the response includes
        `courseSourcedId` and `classSourcedId`.
      security:
        - ApiKeyAuth: []
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
          description: The job identifier returned by the enqueue endpoint.
      responses:
        '200':
          description: Current job status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseBuilderJobStatusResponse'
              examples:
                queued:
                  value: { status: queued, jobId: "01HXYZABCD1234EFG5678" }
                running:
                  value:
                    status: running
                    jobId: "01HXYZABCD1234EFG5678"
                    step: "create_resources"
                    updatedAt: "2025-10-28T22:11:49.256Z"
                completed:
                  value:
                    status: completed
                    jobId: "01HXYZABCD1234EFG5678"
                    result: { courseSourcedId: "nice_x123", classSourcedId: "nice_x123" }
                failed:
                  value:
                    status: failed
                    jobId: "01HXYZABCD1234EFG5678"
                    error: { message: "ai plan references unknown resources" }
        '401':
          description: Unauthorized (missing or invalid API key)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseBuilderErrorResponse'
        '404':
          description: Job not found or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseBuilderErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CourseBuilderErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key

  schemas:
    Subject:
      type: string
      description: Course subject
      enum:
        - Math
        - Science
        - English Language Arts
        - Social Studies
        - Computing
        - General

    CourseBuilderRequest:
      type: object
      required: [case_ids, student_user_id, subject]
      properties:
        case_ids:
          type: array
          minItems: 1
          items:
            type: string
            minLength: 1
          description: CASE learning objective IDs used to scope resources and AI planning.
        student_user_id:
          type: string
          minLength: 1
          description: OneRoster student `sourcedId` to enroll into the created class.
        subject:
          $ref: '#/components/schemas/Subject'

    CourseBuilderEnqueueResponse:
      type: object
      required: [status, jobId, inputSummary]
      properties:
        status:
          type: string
          enum: [queued]
        jobId:
          type: string
        inputSummary:
          type: object
          required: [studentUserId, subject, caseCount]
          properties:
            studentUserId:
              type: string
            subject:
              $ref: '#/components/schemas/Subject'
            caseCount:
              type: integer
              minimum: 1

    CourseBuilderErrorResponse:
      type: object
      required: [status, message]
      properties:
        status:
          type: string
          enum: [error]
        message:
          type: string
          description: Error message

    JobStatusQueued:
      type: object
      required: [status, jobId]
      properties:
        status:
          type: string
          enum: [queued]
        jobId:
          type: string

    JobStatusRunning:
      type: object
      required: [status, jobId, updatedAt]
      properties:
        status:
          type: string
          enum: [running]
        jobId:
          type: string
        step:
          type: string
          nullable: true
          description: Current step name (e.g., fetch_resources, create_course)
        updatedAt:
          type: string
          format: date-time

    JobStatusCompleted:
      type: object
      required: [status, jobId, result]
      properties:
        status:
          type: string
          enum: [completed]
        jobId:
          type: string
        result:
          type: object
          nullable: true
          properties:
            courseSourcedId:
              type: string
            classSourcedId:
              type: string

    JobStatusFailed:
      type: object
      required: [status, jobId, error]
      properties:
        status:
          type: string
          enum: [failed]
        jobId:
          type: string
        error:
          type: object
          nullable: true
          properties:
            message:
              type: string

    CourseBuilderJobStatusResponse:
      oneOf:
        - $ref: '#/components/schemas/JobStatusQueued'
        - $ref: '#/components/schemas/JobStatusRunning'
        - $ref: '#/components/schemas/JobStatusCompleted'
        - $ref: '#/components/schemas/JobStatusFailed'